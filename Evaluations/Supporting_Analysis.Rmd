---
title: "R Notebook"
output: html_notebook
---

load library
```{r message=FALSE, warning=FALSE}
library(Seurat)
library(ggplot2)
library(SingleCellExperiment)
library(scran)
library(SeuratData)
library(edgeR)
library(limma)
library(clusterProfiler)
library(data.table)
library(SingleCellExperiment)
library(SummarizedExperiment)
library(muscat)
library(pROC)
library(igraph)
library(mclust)
library(cluster)
library(SCINA)
library(caret)
library(MAST)
library(AUCell)
library(HGNChelper)
library(SeuratDisk)
library(monocle3)
library(ggpubr)
library(slingshot)
library(grDevices)
library(RColorBrewer)
library(randomForest)
library(caTools)
library(mltools)
#library(stringr)
library(reldist)
library(aricode)
library(TSCAN)
library(reshape2)
library(pheatmap)
library(philentropy)
library(rawr)
library(splatter)
library(combinat)
selected_palette <- c("aquamarine4","azure4","powderblue","burlywood","coral","cornflowerblue","cyan3","darkgoldenrod2","darkorange3","peachpuff","royalblue","khaki2","plum1","lightsalmon")
```

functions
```{r}
getSCC_sc_bulk <- function(ds,col_name,status){
    selectedCells <- metadat[metadat[,col_name]==status,]$cell
    tmp <- apply(ds[,selectedCells],2,function(x) cor(x,bulk_dat[,status],method="spearman"))
    tmp[is.na(tmp)] <- 0
    return(tmp)
}

getSCC_sc_bulk_diff <- function(ds,col_name,status1,status2){
    selectedCells <- metadat[metadat[,col_name]==status1,]$cell
    tmp <- apply(ds[,selectedCells],2,function(x) cor(x,bulk_dat[,status2],method="spearman"))
    tmp[is.na(tmp)] <- 0
    return(tmp)
}

evalSCC_sc_bulk <- function(ds,col_name,status){
    selectedCells <- metadat[metadat[,col_name]==status,]$cell
    tmp_same <- apply(ds[,selectedCells],2,function(x) cor(x,bulk_dat[,status],method="spearman"))
    tmp_same[is.na(tmp_same)] <- 0
    
    diff_status <- unique(metadat[metadat[,col_name]!=status,col_name])
    tmp_diff <- apply(ds[,selectedCells],2,function(x) max(cor(x,bulk_dat[,diff_status],method="spearman")))
    tmp_diff[is.na(tmp_diff)] <- 0
    
    tmp <- tmp_same-tmp_diff
    return(tmp)
}

getSCC_pb_bulk <- function(ds,col_name,status){
    selectedCells <- metadat[metadat[,col_name]==status,]$cell
    median_PB <- apply(ds[,selectedCells],1,median)
    tmp <- cor.test(median_PB,bulk_dat[,status],method="spearman")
    #tmp_p <- tmp$p.value
    tmp_scc <- tmp$estimate
    tmp_scc[is.na(tmp_scc)] <- 0
    return(tmp_scc)
}

getSCC_pb_bulk_diff <- function(ds,col_name,status1,status2){
    selectedCells <- metadat[metadat[,col_name]==status1,]$cell
    median_PB <- apply(ds[,selectedCells],1,median)
    tmp <- cor.test(median_PB,bulk_dat[,status2],method="spearman")
    #tmp_p <- tmp$p.value
    tmp_scc <- tmp$estimate
    tmp_scc[is.na(tmp_scc)] <- 0
    return(tmp_scc)
}

evalSCC_pb_bulk <- function(ds,col_name,status){
    selectedCells <- metadat[metadat[,col_name]==status,]$cell
    median_PB <- apply(ds[,selectedCells],1,median)
    
    tmp_same <- cor(median_PB,bulk_dat[,status],method="spearman")
    tmp_same[is.na(tmp_same)] <- 0
    
    diff_status <- unique(metadat[metadat[,col_name]!=status,col_name])
    tmp_diff <- max(cor(median_PB,bulk_dat[,diff_status],method="spearman"))
    tmp_diff[is.na(tmp_diff)] <- 0
    
    tmp_scc <- tmp_same-tmp_diff
    return(tmp_scc)
}

getSCC_fc <- function(ds,col_name,status1,status2,LFC_cutoff=0){
    selectedCells1 <- metadat[metadat[,col_name]==status1,]$cell
    median_PB1 <- apply(ds[,selectedCells1],1,median)
    selectedCells2 <- metadat[metadat[,col_name]==status2,]$cell
    median_PB2 <- apply(ds[,selectedCells2],1,median)
    LFC_sc <- median_PB1-median_PB2
    LFC_bulk <- bulk_dat[,status1]-bulk_dat[,status2]
    names(LFC_bulk) <- rownames(bulk_dat)
    UsedGenes <- names(LFC_bulk[abs(LFC_bulk)>=LFC_cutoff])
    tmp <- cor.test(LFC_sc[UsedGenes],LFC_bulk[UsedGenes],method="spearman")
    tmp_scc <- tmp$estimate
    tmp_scc[is.na(tmp_scc)] <- 0
    #tmp_p <- tmp$p.value
    return(tmp_scc)
}

getPsig <- function(x){
    if(x>0.1){
        return(" ")
    }else if(x<=0.0005){
        return("***")
    }else if(x<=0.005){
        return("**")
    }else if(x<=0.05){
        return("*")
    }else if(x<=0.1){
        return(".")
    }
}
```

# sc-bulk cor
## processing GSE75748
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- read.csv("bulk/GSE75748_bulk_cell_type_ec.csv",header=TRUE,row.names=1)
bulk_dat <- DGEList(bulk_dat)
keep <- filterByExpr(bulk_dat)
bulk_dat <- bulk_dat[keep,,keep.lib.sizes=FALSE]
bulk_dat <- calcNormFactors(bulk_dat)
bulk_meta <- c("H1","H1","H1","H1","H9","H9","H9","DEC","DEC","EC","EC","EC","HFF","HFF","HFF","NPC","NPC","TB","TB") 
mm <- model.matrix(~0 + bulk_meta)
bulk_dat <- voom(bulk_dat,mm,plot=FALSE)$E
bulk_dat <- data.frame(H1=apply(bulk_dat[,1:4],1,mean),H9=apply(bulk_dat[,5:7],1,mean),DEC=apply(bulk_dat[,8:9],1,mean),EC=apply(bulk_dat[,10:12],1,mean),HFF=apply(bulk_dat[,13:15],1,mean),NPC=apply(bulk_dat[,16:17],1,mean),TB=apply(bulk_dat[,18:19],1,mean))

##raw
raw_dat <- fread("rawcount_txt/GSE75748_sc_cell_type_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE75748_sc_cell_type_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE75748_sc_cell_type_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE75748_sc_cell_type/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE75748_sc_cell_type_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
afMF_dat <- fread("afMF/imputed_data/GSE75748_sc_cell_type_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE75748_sc_cell_type_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE75748_sc_cell_type_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE75748_sc_cell_type_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE75748_sc_cell_type_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE75748_sc_cell_type_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE75748_sc_cell_type_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\_")[[1]][1])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat)
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### single cell level same cell type spearman correlation
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()
res_pct <- data.frame()
for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,getSCC_sc_bulk,"celltype",x))
    res_md <- rbind(res_md,apply(tmp,2,median))
    tmp_pct1 <- apply(tmp[,-1],2,function(x) sum(x>=tmp[,1])/nrow(tmp))
    res_pct <- rbind(res_pct,tmp_pct1)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)
res_pct <- as.data.frame(t(res_pct))
colnames(res_pct) <- celltypes
rownames(res_pct) <- names(dat)[-1]

#writeout
all_res <- list(cor=res_md,improvePCT=res_pct)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameCellType_GSE75748.rds")
```

### relative same-diff SC-Bulk SCC
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()
res_pct <- data.frame()
for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,evalSCC_sc_bulk,"celltype",x))
    res_md <- rbind(res_md,apply(tmp,2,median))
    tmp_pct1 <- apply(tmp[,-1],2,function(x) sum(x>=tmp[,1])/nrow(tmp))
    res_pct <- rbind(res_pct,tmp_pct1)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)
res_pct <- as.data.frame(t(res_pct))
colnames(res_pct) <- celltypes
rownames(res_pct) <- names(dat)[-1]

#writeout
all_res <- list(cor=res_md,improvePCT=res_pct)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameMDiff_GSE75748.rds")
```


### relative same-diff PB-Bulk SCC
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()

for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,evalSCC_pb_bulk,"celltype",x))
    res_md <- rbind(res_md,tmp)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)

#writeout
all_res <- list(cor=res_md)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_PB_SpearCor_SameMDiff_GSE75748.rds")
```

### PB level-bulk fold change between cell types spearman cor
```{r message=FALSE, warning=FALSE}
celltypes <- unique(metadat$celltype)
comb_celltype <- as.data.frame(combn(celltypes,2))
res_md <- data.frame()
PairGroups <- c()

for(i in 1:ncol(comb_celltype)){
    tmp <- as.data.frame(lapply(dat,getSCC_fc,"celltype",comb_celltype[1,i],comb_celltype[2,i]))
    res_md <- rbind(res_md,tmp)
    PairGroups <- c(PairGroups,paste0(comb_celltype[1,i],"_",comb_celltype[2,i]))
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- PairGroups
rownames(res_md) <- names(dat)

#writeout
all_res <- list(cor=res_md)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_PB_SpearCor_DiffCellTypeFC_GSE75748.rds")
```

## processing GSE81861
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- readRDS("bulk/bulk_of_GSE81861_with_replicates_TPM.rds")
bulk_dat <- bulk_dat[rowSums(bulk_dat>0)>0,]
bulk_meta <- c("K562","K562","A549","A549","GM12878","GM12878","K562","K562","IMR90","IMR90","H1","H1","GM12878","GM12878") 
bulk_dat <- log2(bulk_dat+1)
bulk_dat <- data.frame(K562=apply(bulk_dat[,c(1,2,7,8)],1,mean),A549=apply(bulk_dat[,3:4],1,mean),GM12878=apply(bulk_dat[,c(5,6,13,14)],1,mean),IMR90=apply(bulk_dat[,9:10],1,mean),H1=apply(bulk_dat[,11:12],1,mean))

##raw
raw_dat <- fread("rawcount_txt/GSE81861_ENCODE_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE81861_ENCODE_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE81861_ENCODE_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE81861_ENCODE/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE81861_ENCODE_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
afMF_dat <- fread("afMF/imputed_data/GSE81861_ENCODE_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE81861_ENCODE_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE81861_ENCODE_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE81861_ENCODE_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE81861_ENCODE_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE81861_ENCODE_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE81861_ENCODE_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\_")[[1]][1])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat)
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### single cell level same cell type spearman correlation
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()
res_pct <- data.frame()
for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,getSCC_sc_bulk,"celltype",x))
    res_md <- rbind(res_md,apply(tmp,2,median))
    tmp_pct1 <- apply(tmp[,-1],2,function(x) sum(x>=tmp[,1])/nrow(tmp))
    res_pct <- rbind(res_pct,tmp_pct1)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)
res_pct <- as.data.frame(t(res_pct))
colnames(res_pct) <- celltypes
rownames(res_pct) <- names(dat)[-1]

#writeout
all_res <- list(cor=res_md,improvePCT=res_pct)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameCellType_GSE81861.rds")
```


### relative same-diff SC-Bulk SCC
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()
res_pct <- data.frame()
for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,evalSCC_sc_bulk,"celltype",x))
    res_md <- rbind(res_md,apply(tmp,2,median))
    tmp_pct1 <- apply(tmp[,-1],2,function(x) sum(x>=tmp[,1])/nrow(tmp))
    res_pct <- rbind(res_pct,tmp_pct1)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)
res_pct <- as.data.frame(t(res_pct))
colnames(res_pct) <- celltypes
rownames(res_pct) <- names(dat)[-1]

#writeout
all_res <- list(cor=res_md,improvePCT=res_pct)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameMDiff_GSE81861.rds")
```

### relative same-diff PB-Bulk SCC
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()

for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,evalSCC_pb_bulk,"celltype",x))
    res_md <- rbind(res_md,tmp)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)

#writeout
all_res <- list(cor=res_md)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_PB_SpearCor_SameMDiff_GSE81861.rds")
```

### PB level-bulk fold change between cell types spearman cor
```{r message=FALSE, warning=FALSE}
celltypes <- unique(metadat$celltype)
comb_celltype <- as.data.frame(combn(celltypes,2))
res_md <- data.frame()
PairGroups <- c()

for(i in 1:ncol(comb_celltype)){
    tmp <- as.data.frame(lapply(dat,getSCC_fc,"celltype",comb_celltype[1,i],comb_celltype[2,i]))
    res_md <- rbind(res_md,tmp)
    PairGroups <- c(PairGroups,paste0(comb_celltype[1,i],"_",comb_celltype[2,i]))
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- PairGroups
rownames(res_md) <- names(dat)

#writeout
all_res <- list(cor=res_md)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_PB_SpearCor_DiffCellTypeFC_GSE81861.rds")
```


## processing cellbench
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- readRDS("bulk/cellbench/GSE86337_processed_count_average_replicates.rds")

##raw
raw_dat <- fread("rawcount_txt/cellbench_sc_10x_5cl_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/cellbench_sc_10x_5cl_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/cellbench_sc_10x_5cl_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/cellbench_sc_10x_5cl/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/cellbench_sc_10x_5cl_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
afMF_dat <- fread("afMF/imputed_data/cellbench_sc_10x_5cl_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/cellbench_sc_10x_5cl_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/cellbench_sc_10x_5cl_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/cellbench_sc_10x_5cl_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/cellbench_sc_10x_5cl_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/cellbench_sc_10x_5cl_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/cellbench_sc_10x_5cl_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\.")[[1]][2])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### single cell level same cell type spearman correlation
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()
res_pct <- data.frame()
for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,getSCC_sc_bulk,"celltype",x))
    res_md <- rbind(res_md,apply(tmp,2,median))
    tmp_pct1 <- apply(tmp[,-1],2,function(x) sum(x>=tmp[,1])/nrow(tmp))
    res_pct <- rbind(res_pct,tmp_pct1)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)
res_pct <- as.data.frame(t(res_pct))
colnames(res_pct) <- celltypes
rownames(res_pct) <- names(dat)[-1]

#writeout
all_res <- list(cor=res_md,improvePCT=res_pct)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameCellType_cellbench.rds")
```

### relative same-diff SC-Bulk SCC
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()
res_pct <- data.frame()
for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,evalSCC_sc_bulk,"celltype",x))
    res_md <- rbind(res_md,apply(tmp,2,median))
    tmp_pct1 <- apply(tmp[,-1],2,function(x) sum(x>=tmp[,1])/nrow(tmp))
    res_pct <- rbind(res_pct,tmp_pct1)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)
res_pct <- as.data.frame(t(res_pct))
colnames(res_pct) <- celltypes
rownames(res_pct) <- names(dat)[-1]

#writeout
all_res <- list(cor=res_md,improvePCT=res_pct)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameMDiff_cellbench.rds")
```

### relative same-diff PB-Bulk SCC
```{r}
celltypes <- unique(metadat$celltype)
res_md <- data.frame()

for(x in celltypes){
    tmp <- as.data.frame(lapply(dat,evalSCC_pb_bulk,"celltype",x))
    res_md <- rbind(res_md,tmp)
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- celltypes
rownames(res_md) <- names(dat)

#writeout
all_res <- list(cor=res_md)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_PB_SpearCor_SameMDiff_cellbench.rds")
```

### PB level-bulk fold change between cell types spearman cor
```{r message=FALSE, warning=FALSE}
celltypes <- unique(metadat$celltype)
comb_celltype <- as.data.frame(combn(celltypes,2))
res_md <- data.frame()
PairGroups <- c()

for(i in 1:ncol(comb_celltype)){
    tmp <- as.data.frame(lapply(dat,getSCC_fc,"celltype",comb_celltype[1,i],comb_celltype[2,i]))
    res_md <- rbind(res_md,tmp)
    PairGroups <- c(PairGroups,paste0(comb_celltype[1,i],"_",comb_celltype[2,i]))
}
res_md <- as.data.frame(t(res_md))
colnames(res_md) <- PairGroups
rownames(res_md) <- names(dat)

#writeout
all_res <- list(cor=res_md)
saveRDS(all_res,"results/SC_Bulk_Cor/Bulk_PB_SpearCor_DiffCellTypeFC_cellbench.rds")
```



## summary and visualization
### bulk and sc same CT Correlation
read data
```{r}
d1 <- readRDS("results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameCellType_GSE75748.rds")
d2 <- readRDS("results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameCellType_GSE81861.rds")
d3 <- readRDS("results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameCellType_cellbench.rds")
```

process data
```{r}
tmp1 <- t(d1$cor)
rownames(tmp1) <- paste0("GSE75748_",rownames(tmp1))

tmp2 <- t(d2$cor)
rownames(tmp2) <- paste0("GSE81861_",rownames(tmp2))
tmp2 <- tmp2[,colnames(tmp1)]

tmp3 <- t(d3$cor)
rownames(tmp3) <- paste0("cellbench_",rownames(tmp3))
tmp3 <- tmp3[,colnames(tmp1)]

tmp <- rbind(tmp1,tmp2,tmp3)

md_raw <- median(tmp[,1])
res <- as.data.frame(apply(tmp[,-1],2,function(x) x-tmp[,1] ))
res$celltype <- rownames(res)
res_melt <- data.table::melt(res,id.vars=c("celltype"))

res_melt$Type <- "Deep learning based"
res_melt[res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
res_melt[res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
res_melt$Type <- factor(res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(res_melt)

#rank by cor coefficient diff
mdv <- res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value))
rank1 <- mdv[order(mdv$md),]$variable
res_melt$Method <- as.character(res_melt$variable)
res_melt$variable <- factor(res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(tmp[,-1],2,function(x) wilcox.test(tmp[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[rank1]
```

Violin plot
```{r}
tmp_bp <- res_melt[,]

mix_scbulk_same_scc_bp <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("SC-Bulk Profiling SCC Difference(Same Cell Type)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.45,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_scbulk_same_scc_bp
```

heatmap
```{r}
tmp_hm <- res_melt[,]
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_scbulk_same_scc_hm <- ggplot(tmp_hm,aes(variable,celltype,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Methods")+ylab("Datasets&Cell Types")+ggtitle("SC-Bulk Profiling SCC Difference(Same Cell Type)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=9))
mix_scbulk_same_scc_hm
```

### bulk-sc same-diff Correlation
read data
```{r}
d1 <- readRDS("results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameMDiff_GSE75748.rds")
d2 <- readRDS("results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameMDiff_GSE81861.rds")
d3 <- readRDS("results/SC_Bulk_Cor/Bulk_SC_SpearCor_SameMDiff_cellbench.rds")
```

process data
```{r}
tmp1 <- t(d1$cor)
rownames(tmp1) <- paste0("GSE75748_",rownames(tmp1))

tmp2 <- t(d2$cor)
rownames(tmp2) <- paste0("GSE81861_",rownames(tmp2))
tmp2 <- tmp2[,colnames(tmp1)]

tmp3 <- t(d3$cor)
rownames(tmp3) <- paste0("cellbench_",rownames(tmp3))
tmp3 <- tmp3[,colnames(tmp1)]

tmp <- rbind(tmp1,tmp2,tmp3)

md_raw <- median(tmp[,1])
res <- as.data.frame(apply(tmp[,-1],2,function(x) x-tmp[,1] ))
res$celltype <- rownames(res)
res_melt <- data.table::melt(res,id.vars=c("celltype"))

res_melt$Type <- "Deep learning based"
res_melt[res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
res_melt[res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
res_melt$Type <- factor(res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(res_melt)

#rank by cor coefficient diff
mdv <- res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value))
rank1 <- mdv[order(mdv$md),]$variable
res_melt$Method <- as.character(res_melt$variable)
res_melt$variable <- factor(res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(tmp[,-1],2,function(x) wilcox.test(tmp[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[rank1]
```

Violin plot
```{r}
tmp_bp <- res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

mix_scbulk_samediff_scc_bp <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("SC-Bulk Profiling SCC Difference(Relative)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.15,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_scbulk_samediff_scc_bp
```

heatmap
```{r}
tmp_hm <- res_melt[,]
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_scbulk_samediff_scc_hm <- ggplot(tmp_hm,aes(variable,celltype,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Methods")+ylab("Datasets&Cell Types")+ggtitle("SC-Bulk Profiling SCC Difference(Relative)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=9))
mix_scbulk_samediff_scc_hm
```

### bulk-PB same-diff Correlation
read data
```{r}
d1 <- readRDS("results/SC_Bulk_Cor/Bulk_PB_SpearCor_SameMDiff_GSE75748.rds")
d2 <- readRDS("results/SC_Bulk_Cor/Bulk_PB_SpearCor_SameMDiff_GSE81861.rds")
d3 <- readRDS("results/SC_Bulk_Cor/Bulk_PB_SpearCor_SameMDiff_cellbench.rds")
```

process data
```{r}
tmp1 <- t(d1$cor)
rownames(tmp1) <- paste0("GSE75748_",rownames(tmp1))

tmp2 <- t(d2$cor)
rownames(tmp2) <- paste0("GSE81861_",rownames(tmp2))
tmp2 <- tmp2[,colnames(tmp1)]

tmp3 <- t(d3$cor)
rownames(tmp3) <- paste0("cellbench_",rownames(tmp3))
tmp3 <- tmp3[,colnames(tmp1)]

tmp <- rbind(tmp1,tmp2,tmp3)

md_raw <- median(tmp[,1])
res <- as.data.frame(apply(tmp[,-1],2,function(x) x-tmp[,1] ))
res$celltype <- rownames(res)
res_melt <- data.table::melt(res,id.vars=c("celltype"))

res_melt$Type <- "Deep learning based"
res_melt[res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
res_melt[res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
res_melt$Type <- factor(res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(res_melt)

#rank by cor coefficient diff
mdv <- res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value))
rank1 <- mdv[order(mdv$md),]$variable
res_melt$Method <- as.character(res_melt$variable)
res_melt$variable <- factor(res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(tmp[,-1],2,function(x) wilcox.test(tmp[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[rank1]
```

Violin plot
```{r}
tmp_bp <- res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1


mix_pbbulk_samediff_scc_bp <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Pseudobulk-Bulk Profiling SCC Difference(Relative)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.16,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_pbbulk_samediff_scc_bp
```

heatmap
```{r}
tmp_hm <- res_melt[,]
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_pbbulk_samediff_scc_hm <- ggplot(tmp_hm,aes(variable,celltype,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Methods")+ylab("Datasets&Cell Types")+ggtitle("Pseudobulk-Bulk Profiling SCC Difference(Relative)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=9))
mix_pbbulk_samediff_scc_hm
```


### bulk and PB different CT Fold change Correlation
read data
```{r}
d1 <- readRDS("results/SC_Bulk_Cor/Bulk_PB_SpearCor_DiffCellTypeFC_GSE75748.rds")
d2 <- readRDS("results/SC_Bulk_Cor/Bulk_PB_SpearCor_DiffCellTypeFC_GSE81861.rds")
d3 <- readRDS("results/SC_Bulk_Cor/Bulk_PB_SpearCor_DiffCellTypeFC_cellbench.rds")
```

process data
```{r}
tmp1 <- t(d1$cor)
rownames(tmp1) <- paste0("GSE75748_",rownames(tmp1))

tmp2 <- t(d2$cor)
rownames(tmp2) <- paste0("GSE81861_",rownames(tmp2))
tmp2 <- tmp2[,colnames(tmp1)]

tmp3 <- t(d3$cor)
rownames(tmp3) <- paste0("cellbench_",rownames(tmp3))
tmp3 <- tmp3[,colnames(tmp1)]

tmp <- rbind(tmp1,tmp2,tmp3)

md_raw <- median(tmp[,1])
res <- as.data.frame(apply(tmp[,-1],2,function(x) x-tmp[,1] ))
res$celltype <- rownames(res)
res_melt <- data.table::melt(res,id.vars=c("celltype"))

res_melt$Type <- "Deep learning based"
res_melt[res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
res_melt[res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
res_melt$Type <- factor(res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(res_melt)

#rank by cor coefficient diff
mdv <- res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value))
rank1 <- mdv[order(mdv$md),]$variable
res_melt$Method <- as.character(res_melt$variable)
res_melt$variable <- factor(res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(tmp[,-1],2,function(x) wilcox.test(tmp[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[rank1]
```

Violin plot
```{r}
tmp_bp <- res_melt[,]
tmp_bp[tmp_bp$value<(-0.2),]$value <- -0.2

mix_pbbulk_fc_scc_bp <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Pseudobulk-Bulk Cell-Type logFC SCC Difference")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.42,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_pbbulk_fc_scc_bp
```

heatmap
```{r fig.height=3.5}
tmp_hm <- res_melt[,]
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_pbbulk_fc_scc_hm <- ggplot(tmp_hm,aes(variable,celltype,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Methods")+ylab("Datasets&Cell Types")+ggtitle("Pseudobulk-Bulk Cell-Type logFC SCC Difference")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=9))
mix_pbbulk_fc_scc_hm
```



# Correlation between sc and ADT CITE seq surface protein
functions
```{r}
getSCC_CITE <- function(sc,prot){
    sc <- t(sc)
    prot <- t(prot)
    tmp <- sapply(1:ncol(sc),function(x) cor(sc[,x],prot[,x],method="spearman") )
    return(tmp)
}

getPsig <- function(x){
    if(x>0.1){
        return(" ")
    }else if(x<=0.0005){
        return("***")
    }else if(x<=0.005){
        return("**")
    }else if(x<=0.05){
        return("*")
    }else if(x<=0.1){
        return(".")
    }
}
```

## GSE100866 CBMC
### pre-process
read data
```{r message=FALSE, warning=FALSE}
##ADT
ADT_dat <- read.csv("rawcount_txt/GSE100866_CBMC_8K_13AB_10X-ADT_clr-transformed.csv",header=TRUE,row.names=1)

##raw
raw_dat <- fread("rawcount_txt/GSE100866_CBMC_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE100866_CBMC_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE100866_CBMC_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE100866_CBMC/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE100866_CBMC_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
afMF_dat <- fread("afMF/imputed_data/GSE100866_CBMC_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE100866_CBMC_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE100866_CBMC_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE100866_CBMC_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE100866_CBMC_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE100866_CBMC_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE100866_CBMC_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)
```

normalize data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#align cell names
ADT_dat <- ADT_dat[,colnames(ADT_dat)%in%colnames(dat$raw)]
dat <- lapply(dat,function(x) x[,colnames(ADT_dat)] )

#remove inconsistant genes
rownames(ADT_dat) <- paste0("HUMAN-",rownames(ADT_dat))
ADT_dat <- ADT_dat[rownames(ADT_dat)%in%rownames(dat$raw),]
dat <- lapply(dat,function(x) x[rownames(ADT_dat),] )
```

spearman correlation(each gene-protein)
```{r}
res1 <- t(as.data.frame(lapply(dat,getSCC_CITE,ADT_dat)))
colnames(res1) <- rownames(ADT_dat)
res1 <- as.data.frame(res1)
apply(res1,1,median)
```

## GSE100866 PBMC
### pre-process
read data
```{r message=FALSE, warning=FALSE}
##ADT
ADT_dat <- read.csv("rawcount_txt/GSE100866_PBMC_vs_flow_10X-ADT_clr-transformed.csv",header=TRUE,row.names=1)

##raw
raw_dat <- fread("rawcount_txt/GSE100866_PBMC_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE100866_PBMC_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE100866_PBMC_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE100866_PBMC/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE100866_PBMC_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
afMF_dat <- fread("afMF/imputed_data/GSE100866_PBMC_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE100866_PBMC_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE100866_PBMC_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE100866_PBMC_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE100866_PBMC_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE100866_PBMC_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE100866_PBMC_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)
```

normalize data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#align cell names
ADT_dat <- ADT_dat[,colnames(ADT_dat)%in%colnames(dat$raw)]
dat <- lapply(dat,function(x) x[,colnames(ADT_dat)] )

#remove inconsistant genes
rownames(ADT_dat) <- paste0("HUMAN-",rownames(ADT_dat))
ADT_dat <- ADT_dat[rownames(ADT_dat)%in%rownames(dat$raw),]
dat <- lapply(dat,function(x) x[rownames(ADT_dat),] )
```

spearman correlation(each gene-protein)
```{r}
res2 <- t(as.data.frame(lapply(dat,getSCC_CITE,ADT_dat)))
colnames(res2) <- rownames(ADT_dat)
res2 <- as.data.frame(res2)
apply(res2,1,median)
```

## summary and visualization
process data
```{r}
res1 <- as.data.frame(t(res1))
rownames(res1) <- paste0("CBMC_",rownames(res1))
res2 <- as.data.frame(t(res2))
rownames(res2) <- paste0("PBMC_",rownames(res2))
res <- rbind(res1,res2)

md_raw <- median(res$raw)
res_diff <- as.data.frame(apply(res[,-1],2,function(x) x-res[,1] ))
res_diff$Dataset_Gene <- rownames(res)
res_melt <- data.table::melt(res_diff,id.vars=c("Dataset_Gene"))

res_melt$Type <- "Deep learning based"
res_melt[res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
res_melt[res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
res_melt$Type <- factor(res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(res_melt)

#rank by cor coefficient diff
mdv <- res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value))
rank1 <- mdv[order(mdv$md),]$variable
res_melt$Method <- as.character(res_melt$variable)
res_melt$variable <- factor(res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(res[,-1],2,function(x) wilcox.test(res[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[rank1]
```

Violin plot
```{r}
tmp_bp <- res_melt[,]

SP_mRNA_scc_bp <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Single Cell Surface Protein-mRNA SCC Difference")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.4,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
SP_mRNA_scc_bp
```

heatmap
```{r}
tmp_hm <- res_melt[,]
colnames(tmp_hm)[3] <- "SCC_Difference"
SP_mRNA_scc_hm <- ggplot(tmp_hm,aes(variable,Dataset_Gene,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Methods")+ylab("Datasets&Gene")+ggtitle("Single Cell Surface Protein-mRNA SCC Difference")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=12))
SP_mRNA_scc_hm
```



# cell-cell correlation
## cellbench
### read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- readRDS("bulk/cellbench/GSE86337_processed_count_average_replicates.rds")
##raw
raw_dat <- fread("rawcount_txt/cellbench_sc_10x_5cl_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/cellbench_sc_10x_5cl_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/cellbench_sc_10x_5cl_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/cellbench_sc_10x_5cl/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/cellbench_sc_10x_5cl_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
afMF_dat <- fread("afMF/imputed_data/cellbench_sc_10x_5cl_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/cellbench_sc_10x_5cl_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/cellbench_sc_10x_5cl_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/cellbench_sc_10x_5cl_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/cellbench_sc_10x_5cl_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/cellbench_sc_10x_5cl_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/cellbench_sc_10x_5cl_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\.")[[1]][2])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### pearson correlation cell-cell
```{r fig.height=3, fig.width=4}
plotHeatmap <- function(sc,meta,method){
    tmp <- sc[,order(meta$celltype)]
    cormat <- cor(tmp)
    tmpmeta <- meta[order(meta$celltype),]
    tmpmeta <- data.frame(cell_type=tmpmeta$celltype,row.names=tmpmeta$cell)
    pheatmap(cormat,cluster_cols=F,cluster_rows=F,show_colnames=F,show_rownames=F,annotation_col=tmpmeta,annotation_row=tmpmeta,main=method)
}

for(x in names(dat)[c(1,12,2,3,9,10)]){
    print(plotHeatmap(dat[[x]],metadat,x))
}
```

```{r fig.height=3, fig.width=4}
for(x in names(dat)[c(4:8,11)]){
    print(plotHeatmap(dat[[x]],metadat,x))
}
```

# combine plots
## main
```{r fig.height=5.4, fig.width=8}
ggarrange(mix_scbulk_samediff_scc_bp,mix_pbbulk_samediff_scc_bp,mix_pbbulk_fc_scc_bp,SP_mRNA_scc_bp,ncol=2,nrow=2,labels="AUTO")
```

## supp
```{r fig.height=7.5, fig.width=7.8}
ggarrange(mix_scbulk_same_scc_bp,mix_scbulk_same_scc_hm,mix_scbulk_samediff_scc_hm,mix_pbbulk_samediff_scc_hm,mix_pbbulk_fc_scc_hm,SP_mRNA_scc_hm,ncol=2,nrow=3,labels="AUTO")
```

