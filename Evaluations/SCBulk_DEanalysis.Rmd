---
title: "DE analysis"
output: html_notebook
---

load library
```{r message=FALSE, warning=FALSE}
library(Seurat)
library(ggplot2)
library(SingleCellExperiment)
library(scran)
library(SeuratData)
library(edgeR)
library(limma)
library(clusterProfiler)
library(data.table)
library(SingleCellExperiment)
library(SummarizedExperiment)
library(muscat)
library(pROC)
library(igraph)
library(mclust)
library(cluster)
library(SCINA)
library(caret)
library(robCompositions)
library(easyCODA)
library(MAST)
library(AUCell)
library(HGNChelper)
library(SeuratDisk)
library(scmap)
library(monocle3)
library(ggpubr)
library(slingshot)
library(grDevices)
library(RColorBrewer)
library(randomForest)
library(caTools)
library(mltools)
#library(stringr)
library(reldist)
library(aricode)
library(TSCAN)
library(reshape2)
library(pheatmap)
library(philentropy)
library(SCeQTL)
library(eQTLsingle)
library(rawr)
library(splatter)
library(combinat)

selected_palette <- c("aquamarine4","azure4","powderblue","burlywood","coral","cornflowerblue","cyan3","darkgoldenrod2","darkorange3","peachpuff","royalblue","khaki2","plum1","lightsalmon")
```

functions
```{r}
performDE_bulk <- function(ds,cond,status1,status2){
    #bulk
    mm <- model.matrix(~0 + cond)
    y <- voom(ds,mm,plot=F)
    fit <- lmFit(y, mm)
    #print(head(coef(fit)))
    exp_tmp <- sprintf("cond%s-cond%s",status2,status1)
    myargs <- list(exp_tmp,levels=colnames(coef(fit)))
    contr  <- do.call(makeContrasts,myargs)
    #contr <- makeContrasts(exp_tmp, levels=colnames(coef(fit)))
    tmp <- contrasts.fit(fit,contr)
    tmp <- eBayes(tmp)
    top.table <- topTable(tmp,sort.by="P",n=Inf)
    ## set p=0 to min
    top.table[top.table$P.Value==0,"P.Value"] <- min(top.table[top.table$P.Value!=0,"P.Value"])
    top.table$log10FDR <- log10(top.table$adj.P.Val)*(-1)
    top.table$log10P <- log10(top.table$P.Value)*(-1)
    top.table$signlogFDR <- sign(top.table$logFC)*top.table$log10FDR
    top.table$signlogP <- sign(top.table$logFC)*top.table$log10P
    
    top.table <- top.table[order(top.table[,"signlogP"],abs(top.table[,"logFC"]),decreasing=TRUE),]
    top.table$finalRank <- 1:nrow(top.table)
    return(top.table)
}

#limma trend for pre-normalized data
performDE_bulkTPM <- function(ds,cond,status1,status2){
    #bulk
    mm <- model.matrix(~0 + cond)
    fit <- lmFit(ds,mm)
    #print(head(coef(fit)))
    exp_tmp <- sprintf("cond%s-cond%s",status2,status1)
    myargs <- list(exp_tmp,levels=colnames(coef(fit)))
    contr  <- do.call(makeContrasts,myargs)
    #contr <- makeContrasts(exp_tmp, levels=colnames(coef(fit)))
    tmp <- contrasts.fit(fit,contr)
    tmp <- eBayes(tmp,trend=TRUE)
    top.table <- topTable(tmp,sort.by="P",n=Inf)
    ## set p=0 to min
    top.table[top.table$P.Value==0,"P.Value"] <- min(top.table[top.table$P.Value!=0,"P.Value"])
    top.table$log10FDR <- log10(top.table$adj.P.Val)*(-1)
    top.table$log10P <- log10(top.table$P.Value)*(-1)
    top.table$signlogFDR <- sign(top.table$logFC)*top.table$log10FDR
    top.table$signlogP <- sign(top.table$logFC)*top.table$log10P
    
    top.table <- top.table[order(top.table[,"signlogP"],abs(top.table[,"logFC"]),decreasing=TRUE),]
    top.table$finalRank <- 1:nrow(top.table)
    return(top.table)
}

performDE_bulk_timecourse <- function(ds,meta){
    cond <- as.numeric(meta)
    mm <- model.matrix(~cond)
    y <- voom(ds,mm,plot=F)
    fit <- lmFit(y,mm)
    tmp <- contrasts.fit(fit,coef=2)
    tmp <- eBayes(tmp)
    top.table <- topTable(tmp,sort.by="P",n=Inf)
    ## set p=0 to min
    top.table[top.table$P.Value==0,"P.Value"] <- min(top.table[top.table$P.Value!=0,"P.Value"])
    top.table$log10FDR <- log10(top.table$adj.P.Val)*(-1)
    top.table$log10P <- log10(top.table$P.Value)*(-1)
    top.table$signlogFDR <- sign(top.table$logFC)*top.table$log10FDR
    top.table$signlogP <- sign(top.table$logFC)*top.table$log10P
    
    top.table <- top.table[order(top.table[,"signlogP"],abs(top.table[,"logFC"]),decreasing=TRUE),]
    top.table$finalRank <- 1:nrow(top.table)
    return(top.table)
}

performDE_sc <- function(ds,meta,label_col,status1,status2,method="rank_sum"){
    
    if(method=="rank_sum"){
        selectedCells <- which(meta[,label_col]%in%c(status1,status2))
        conditions <- factor(meta[selectedCells,label_col],levels=c(status1,status2))
        tmp_ds <- ds[,selectedCells]
        pvalues <- sapply(1:nrow(tmp_ds), function(i){
            dat <- cbind.data.frame(gene=as.numeric(t(tmp_ds[i,])),conditions)
            p <- wilcox.test(gene~conditions, dat)$p.value
            return(p)
        })
        ## set NA to 1
        pvalues <- ifelse(is.na(pvalues),1,pvalues)
        ## set p=0 to min
        pvalues[pvalues==0] <- min(pvalues[pvalues!=0])
        fdr <- p.adjust(pvalues,method="fdr")
        # Calculate the fold-change for each gene
        conditionsLevel <- levels(conditions)
        dataCon1 <- tmp_ds[,c(which(conditions==conditionsLevel[1]))]
        dataCon2 <- tmp_ds[,c(which(conditions==conditionsLevel[2]))]
        foldChanges <- rowMeans(dataCon2)-rowMeans(dataCon1)
        outRst <- data.frame(logFC=foldChanges,P.Value=pvalues,FDR=fdr)
        rownames(outRst) <- rownames(tmp_ds)
        #outRst <- outRst[order(outRst[,"P.Value"],-abs(outRst[,"logFC"])),]
        outRst$log10FDR <- log10(outRst$FDR)*(-1)
        outRst$log10P <- log10(outRst$P.Value)*(-1)
        outRst$signlogFDR <- sign(outRst$logFC)*outRst$log10FDR
        outRst$signlogP <- sign(outRst$logFC)*outRst$log10P
        
        outRst <- outRst[order(outRst[,"signlogP"],abs(outRst[,"logFC"]),decreasing=TRUE),]
        outRst$finalRank <- 1:nrow(outRst)
        outRst <- outRst[rownames(ds),]
        return(outRst)
        
    }else if(method=="MAST"){
        tmp <- FromMatrix(ds,meta,data.frame(features=rownames(ds)),check_sanity=FALSE)
        cdr2 <-colSums(assay(tmp)>0)
        colData(tmp)$cngeneson <- scale(cdr2)

        tmp <- tmp[,which(tmp@colData[,label_col]%in%c(status1,status2))]
        cond <- factor(colData(tmp)[,label_col],levels=c(status1,status2))
        colData(tmp)$cond <- cond
        if(length(unique(cdr2))==1){
            zlmCond <- zlm(~cond,tmp)
        }else{
            zlmCond <- zlm(~cond+cngeneson,tmp)
        }
        tmpterm <- paste0("cond",status2)
        summaryCond <- summary(zlmCond,doLRT=tmpterm)
        summaryDt <- as.data.frame(summaryCond$datatable)
        pval <- summaryDt[summaryDt$component=="H"&summaryDt$contrast==tmpterm,c(1,4)]
        lfc <- summaryDt[summaryDt$component=="logFC"&summaryDt$contrast==tmpterm,c(1,7)]
        res <- merge(pval,lfc)
        colnames(res) <- c("Gene","P.Value","logFC")
        rownames(res) <- res$Gene
        #res <- res[order(res[,"P.Value"],-abs(res[,"logFC"])),]
        ## set NA to 1
        res$P.Value <- ifelse(is.na(res$P.Value),1,res$P.Value)
        ## set p=0 to min
        res[res$P.Value==0,"P.Value"] <- min(res[res$P.Value!=0,"P.Value"])
        res$FDR <- p.adjust(res$P.Value,method="fdr")
        res$log10FDR <- log10(res$FDR)*(-1)
        res$log10P <- log10(res$P.Value)*(-1)
        res$signlogFDR <- sign(res$logFC)*res$log10FDR
        res$signlogP <- sign(res$logFC)*res$log10P
        
        res <- res[order(res[,"signlogP"],abs(res[,"logFC"]),decreasing=TRUE),]
        res$finalRank <- 1:nrow(res)
        res <- res[rownames(ds),]
        return(res)
    }
}

getSCC <- function(sc,bulk){
    res <- cor.test(sc,bulk,method="pearson")
    #return(list(estimate=res$estimate,p=res$p.value))
    return(res$estimate)
}

getSCC2 <- function(sc,bulk){
    #selectedG <- which(!is.nan(sc)) 
    #sc <- sc[selectedG]
    #bulk <- bulk[selectedG]
    res <- tryCatch(
        {
            res <- cor.test(sc,bulk,method="spearman")
            #return(list(estimate=res$estimate,p=res$p.value))
            return(res$estimate)
        },
        error=function(cond){
            return(NA)
        }
    )
    return(res)
}

getOverlappedDEGs <- function(scd,top_n,allgenes,bulk_degs){
    names(scd) <- allgenes
    top_degs <- names(scd[order(scd)])[1:top_n]
    return(sum(top_degs%in%bulk_degs)/top_n)
}

getOverlappedDEGs2 <- function(scd,top_n,allgenes,bulk_degs){
    names(scd) <- allgenes
    top_degs <- names(scd[order(scd)])[1:top_n]
    return(sum(top_degs%in%bulk_degs)/length(bulk_degs))
}

getJaccard <- function(scd,top_n,allgenes,bulk_degs){
    names(scd) <- allgenes
    top_degs <- names(scd[order(scd)])[1:top_n]
    interS <- length(intersect(top_degs,bulk_degs))
    unionS <- length(top_degs)+length(bulk_degs)-interS
    return(interS/unionS)
}

getAllEval <- function(bulkds,scds){
    # bulk_res1 <- performDE_bulk(bulkds,bulkconds,status1,status2)
    # sc_res1 <- as.data.frame(lapply(scds,performDE_sc,scmeta,label_col,status1,status2))
    sc_res1 <- scds[rownames(bulkds),]
    bulk_res1 <- bulkds[,]
    #correlation between rank
    tmp1 <- sc_res1[,grep("finalRank",colnames(sc_res1))]
    tmp1 <- apply(tmp1,2,getSCC,bulk_res1[,"finalRank"])
    tmp1 <- as.data.frame(tmp1)
    #0.05
    #SelectedG <- rownames(bulk_res1[bulk_res1$P.Value<=0.05,])
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:1000]
    tmp4 <- sc_res1[SelectedG,grep("finalRank",colnames(sc_res1))]
    tmp4 <- apply(tmp4,2,getSCC,bulk_res1[SelectedG,"finalRank"])
    tmp4 <- as.data.frame(tmp4)

    tmp_p <- cbind(tmp1,tmp4)
    colnames(tmp_p) <- c("all","0.05")
    
    #correlation between logFC
    tmp1 <- sc_res1[,grep("logFC",colnames(sc_res1))]
    tmp1 <- apply(tmp1,2,getSCC2,bulk_res1[,"logFC"])
    tmp1 <- as.data.frame(tmp1)
    #0.05
    #SelectedG <- rownames(bulk_res1[bulk_res1$adj.P.Val<=0.05,])
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:1000]
    tmp4 <- sc_res1[SelectedG,grep("logFC",colnames(sc_res1))]
    tmp4 <- apply(tmp4,2,getSCC2,bulk_res1[SelectedG,"logFC"])
    tmp4 <- as.data.frame(tmp4)
    tmp_fc <- cbind(tmp1,tmp4)
    colnames(tmp_fc) <- c("all","0.05")
    
    return(list(p=tmp_p,fc=tmp_fc))
}

getAllEval_TopRank <- function(bulkds,scds){
    
    sc_res1 <- scds[rownames(bulkds),]
    bulk_res1 <- bulkds[,]
    #correlation between rank
    tmp1 <- sc_res1[,grep("finalRank",colnames(sc_res1))]
    tmp1 <- apply(tmp1,2,getSCC,bulk_res1[,"finalRank"])
    tmp1 <- as.data.frame(tmp1)
    #100
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:100]
    tmp2 <- sc_res1[SelectedG,grep("finalRank",colnames(sc_res1))]
    tmp2 <- apply(tmp2,2,getSCC,bulk_res1[SelectedG,"finalRank"])
    tmp2 <- as.data.frame(tmp2)
    #250
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:250]
    tmp3 <- sc_res1[SelectedG,grep("finalRank",colnames(sc_res1))]
    tmp3 <- apply(tmp3,2,getSCC,bulk_res1[SelectedG,"finalRank"])
    tmp3 <- as.data.frame(tmp3)
    #500
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:500]
    tmp4 <- sc_res1[SelectedG,grep("finalRank",colnames(sc_res1))]
    tmp4 <- apply(tmp4,2,getSCC,bulk_res1[SelectedG,"finalRank"])
    tmp4 <- as.data.frame(tmp4)
    #1000
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:1000]
    tmp5 <- sc_res1[SelectedG,grep("finalRank",colnames(sc_res1))]
    tmp5 <- apply(tmp5,2,getSCC,bulk_res1[SelectedG,"finalRank"])
    tmp5 <- as.data.frame(tmp5)

    tmp_p <- cbind(tmp1,tmp2,tmp3,tmp4,tmp5)
    colnames(tmp_p) <- c("all","top100","top250","top500","top1000")
    
    #correlation between logFC
    tmp1 <- sc_res1[,grep("logFC",colnames(sc_res1))]
    tmp1 <- apply(tmp1,2,getSCC2,bulk_res1[,"logFC"])
    tmp1 <- as.data.frame(tmp1)
    #100
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:100]
    tmp2 <- sc_res1[SelectedG,grep("logFC",colnames(sc_res1))]
    tmp2 <- apply(tmp2,2,getSCC2,bulk_res1[SelectedG,"logFC"])
    tmp2 <- as.data.frame(tmp2)
    #250
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:250]
    tmp3 <- sc_res1[SelectedG,grep("logFC",colnames(sc_res1))]
    tmp3 <- apply(tmp3,2,getSCC2,bulk_res1[SelectedG,"logFC"])
    tmp3 <- as.data.frame(tmp3)
    #500
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:500]
    tmp4 <- sc_res1[SelectedG,grep("logFC",colnames(sc_res1))]
    tmp4 <- apply(tmp4,2,getSCC2,bulk_res1[SelectedG,"logFC"])
    tmp4 <- as.data.frame(tmp4)
    #1000
    SelectedG <- rownames(bulk_res1[order(bulk_res1$P.Value),])[1:1000]
    tmp5 <- sc_res1[SelectedG,grep("logFC",colnames(sc_res1))]
    tmp5 <- apply(tmp5,2,getSCC2,bulk_res1[SelectedG,"logFC"])
    tmp5 <- as.data.frame(tmp5)
    
    tmp_fc <- cbind(tmp1,tmp2,tmp3,tmp4,tmp5)
    colnames(tmp_fc) <- c("all","top100","top250","top500","top1000")
    
    return(list(p=tmp_p,fc=tmp_fc))
    #return(list(p=tmp_p))
}

getAllOverlap <- function(bulkds,scds,nbulkDEGs=100,nscDEGs=100*c(1:5)){
    
    sc_DEGs <- scds[,grep("P.Value",colnames(scds))]
    bulk_DEGs <- rownames(bulkds[order(bulkds$P.Value),])

    sc_DEGs1 <- lapply(nscDEGs,function(x) as.data.frame(apply(sc_DEGs,2,getOverlappedDEGs2,x,rownames(sc_DEGs),bulk_DEGs[1:nbulkDEGs])))
    sc_DEGs1 <- as.data.frame(sc_DEGs1)
    colnames(sc_DEGs1) <- paste0("scTOP",nscDEGs)
    
    sc_jaccard1 <- lapply(nscDEGs,function(x) as.data.frame(apply(sc_DEGs,2,getJaccard,x,rownames(sc_DEGs),bulk_DEGs[1:nbulkDEGs])))
    sc_jaccard1 <- as.data.frame(sc_jaccard1)
    colnames(sc_jaccard1) <- paste0("scTOP",nscDEGs)
    
    return(list(overlap=sc_DEGs1,jaccard=sc_jaccard1))
}

performPBDE_sc_RST <- function(ds,meta,label_col,sample_col,cellt_col,status1,status2){
    tmp <- SingleCellExperiment(ds,colData=meta,mainExpName="log2norm")
    tmp <- prepSCE(tmp,kid=cellt_col,gid=label_col,sid=sample_col,drop=FALSE)
    assayNames(tmp) <- "log2norm"
    tmp <- aggregateData(tmp,assay="log2norm",fun="mean",by=c("cluster_id","sample_id"))
    conds <- tmp$group_id

    #Rank sum
    tmpdat <- tmp@assays@data[[1]]
    pvalues <- sapply(1:nrow(tmpdat), function(i){
        dat <- cbind.data.frame(gene=as.numeric(t(tmpdat[i,])),conds)
        p <- wilcox.test(gene~conds, dat)$p.value
        return(p)
    })
    ## set NA to 1
    pvalues <- ifelse(is.na(pvalues),1,pvalues)
    ## set p=0 to min
    pvalues[pvalues==0] <- min(pvalues[pvalues!=0])
    fdr <- p.adjust(pvalues, method="fdr")
    # Calculate the fold-change for each gene
    #conditionsLevel <- levels(conds)
    dataCon1 <- tmpdat[,c(which(conds==status1))]
    dataCon2 <- tmpdat[,c(which(conds==status2))]
    foldChanges <- rowMeans(dataCon2)-rowMeans(dataCon1)
    outRst <- data.frame(logFC=foldChanges,P.Value=pvalues,FDR=fdr)
    rownames(outRst) <- rownames(tmpdat)
    outRst$log10FDR <- log10(outRst$FDR)*(-1)
    outRst$log10P <- log10(outRst$P.Value)*(-1)
    outRst$signlogFDR <- sign(outRst$logFC)*outRst$log10FDR
    outRst$signlogP <- sign(outRst$logFC)*outRst$log10P
    
    outRst <- outRst[order(outRst[,"signlogP"],abs(outRst[,"logFC"]),decreasing=TRUE),]
    outRst$finalRank <- 1:nrow(outRst)
    outRst <- outRst[rownames(ds),]
    return(outRst)
}

#limma trend for pre-normalized data
performPBDE_sc_limma <- function(ds,meta,label_col,sample_col,cellt_col,status1,status2){
    tmp <- SingleCellExperiment(ds,colData=meta,mainExpName="log2norm")
    tmp <- prepSCE(tmp,kid=cellt_col,gid=label_col,sid=sample_col,drop=FALSE)
    assayNames(tmp) <- "log2norm"
    tmp <- aggregateData(tmp,assay="log2norm",fun="mean",by=c("cluster_id","sample_id"))
    conds <- tmp$group_id

    #limma
    mm <- model.matrix(~0 + conds)
    fit <- lmFit(tmp@assays@data[[1]],mm)
    exp_tmp <- sprintf("conds%s-conds%s",status2,status1)
    myargs <- list(exp_tmp,levels=colnames(coef(fit)))
    contr  <- do.call(makeContrasts,myargs)
    tmp <- contrasts.fit(fit,contr)
    tmp <- eBayes(tmp,trend=TRUE)
    top.table <- topTable(tmp,sort.by="P",n=Inf)
    ## set NA to 1
    top.table$P.Value <- ifelse(is.na(top.table$P.Value),1,top.table$P.Value)
    ## set p=0 to min
    top.table$P.Value[top.table$P.Value==0] <- min(top.table$P.Value[top.table$P.Value!=0])
    top.table$log10FDR <- log10(top.table$adj.P.Val)*(-1)
    top.table$log10P <- log10(top.table$P.Value)*(-1)
    top.table$signlogFDR <- sign(top.table$logFC)*top.table$log10FDR
    top.table$signlogP <- sign(top.table$logFC)*top.table$log10P
    top.table <- top.table[order(top.table[,"signlogP"],abs(top.table[,"logFC"]),decreasing=TRUE),]
    top.table$finalRank <- 1:nrow(top.table)
    top.table <- top.table[rownames(ds),]
    return(top.table)
}

getPsig <- function(x){
    if(x>0.1){
        return(" ")
    }else if(x<=0.0005){
        return("***")
    }else if(x<=0.005){
        return("**")
    }else if(x<=0.05){
        return("*")
    }else if(x<=0.1){
        return(".")
    }
}

cuzickTest <- function(x,g){
    tmp <- cuzick.test(x=x,g=g)
    tmp_res <- t(data.frame(z=tmp$statistic,p=tmp$p.value))
    return(tmp_res)
}

getTrendRStest <- function(x,meta,t_col){
    print("start")
    tmp <- apply(x,1,function(y) cuzickTest(y,g=meta[,t_col]) )
    top.table <- as.data.frame(t(as.data.frame(tmp)))
    #logFC refers to Z here
    colnames(top.table) <- c("logFC","P.Value")
    top.table$P.Value <- ifelse(is.na(top.table$P.Value),1,top.table$P.Value)
    ## set p=0 to min
    top.table$P.Value[top.table$P.Value==0] <- min(top.table$P.Value[top.table$P.Value!=0])
    top.table$adj.P.Val <- p.adjust(top.table$P.Value,method="fdr")
    top.table$log10FDR <- log10(top.table$adj.P.Val)*(-1)
    top.table$log10P <- log10(top.table$P.Value)*(-1)
    top.table$signlogFDR <- sign(top.table$logFC)*top.table$log10FDR
    top.table$signlogP <- sign(top.table$logFC)*top.table$log10P
    top.table <- top.table[order(top.table[,"signlogP"],abs(top.table[,"logFC"]),decreasing=TRUE),]
    top.table$finalRank <- 1:nrow(top.table)
    return(top.table[rownames(x),])
}

getMASTcont <- function(x,meta,status){
    print("start")
    tmp <- FromMatrix(x,meta,data.frame(features=rownames(x)),check_sanity=FALSE)
    cdr2 <-colSums(assay(tmp)>0)
    colData(tmp)$cngeneson <- scale(cdr2)
    colData(tmp)$cond <- colData(tmp)[,status]
    if(length(unique(cdr2))==1){
        zlmCond <- zlm(~cond,tmp)
        }else{
        zlmCond <- zlm(~cond+cngeneson,tmp)
    }
    summaryCond <- summary(zlmCond,doLRT="cond")
    summaryDt <- as.data.frame(summaryCond$datatable)
    pval <- summaryDt[summaryDt$component=="H"&summaryDt$contrast=="cond",c(1,4)]
    lfc <- summaryDt[summaryDt$component=="logFC"&summaryDt$contrast=="cond",c(1,7)]
    res <- merge(pval,lfc)
    colnames(res) <- c("Gene","P.Value","logFC")
    rownames(res) <- res$Gene
    ## set NA to 1
    res$P.Value <- ifelse(is.na(res$P.Value),1,res$P.Value)
    ## set p=0 to min
    res[res$P.Value==0,"P.Value"] <- min(res[res$P.Value!=0,"P.Value"])
    res$FDR <- p.adjust(res$P.Value,method="fdr")
    res$log10FDR <- log10(res$FDR)*(-1)
    res$log10P <- log10(res$P.Value)*(-1)
    res$signlogFDR <- sign(res$logFC)*res$log10FDR
    res$signlogP <- sign(res$logFC)*res$log10P
        
    res <- res[order(res[,"signlogP"],abs(res[,"logFC"]),decreasing=TRUE),]
    res$finalRank <- 1:nrow(res)
    res <- res[rownames(x),]
    return(res)
}

data_summary <- function(dat,varname,groupnames){
  require(plyr)
  summary_func <- function(x,col){
    c(median=median(x[[col]],na.rm=TRUE),
      sd=sd(x[[col]],na.rm=TRUE))
  }
  data_sum <- ddply(dat,groupnames,.fun=summary_func,varname)
  data_sum <- rename(data_sum,c("median"=varname))
  return(data_sum)
}
```

# mixture cell type samples
## GSE75748 cell type
### preprocess
read data
```{r message=FALSE, warning=FALSE}
#cell bench
##bulk
bulk_dat <- read.csv("bulk/GSE75748_bulk_cell_type_ec.csv",header=TRUE,row.names=1)
bulk_dat <- DGEList(bulk_dat)
keep <- filterByExpr(bulk_dat)
bulk_dat <- bulk_dat[keep,,keep.lib.sizes=FALSE]
bulk_dat <- calcNormFactors(bulk_dat)
bulk_meta <- c("H1","H1","H1","H1","H9","H9","H9","DEC","DEC","EC","EC","EC","HFF","HFF","HFF","NPC","NPC","TB","TB") 

##raw
raw_dat <- fread("rawcount_txt/GSE75748_sc_cell_type_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE75748_sc_cell_type_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE75748_sc_cell_type_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE75748_sc_cell_type/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE75748_sc_cell_type_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)

AutoClass_dat <- fread("AutoClass/GSE75748_sc_cell_type_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE75748_sc_cell_type_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE75748_sc_cell_type_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE75748_sc_cell_type_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE75748_sc_cell_type_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE75748_sc_cell_type_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/GSE75748_sc_cell_type_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\_")[[1]][1])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat)
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(New_dat)
rm(afMF_dat)
rm(afMF6_dat)

#remove inconsistant genes
colnames(dat$ALRA) <- rownames(metadat)
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$celltype)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"celltype",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_GSE75748.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$celltype)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"celltype",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_GSE75748.rds")
```

## GSE81861
### preprocess
read data
```{r message=FALSE, warning=FALSE}
bulk_dat <- readRDS("bulk/bulk_of_GSE81861_with_replicates_TPM.rds")
bulk_dat <- bulk_dat[rowSums(bulk_dat>0)>0,]
filterGene <- which(apply(bulk_dat,1,max)<5)
bulk_dat <- bulk_dat[-filterGene,]
bulk_meta <- c("K562","K562","A549","A549","GM12878","GM12878","K562","K562","IMR90","IMR90","H1","H1","GM12878","GM12878") 
bulk_dat <- log2(bulk_dat+1)

##raw
raw_dat <- fread("rawcount_txt/GSE81861_ENCODE_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE81861_ENCODE_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE81861_ENCODE_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE81861_ENCODE/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE81861_ENCODE_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE81861_ENCODE_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE81861_ENCODE_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE81861_ENCODE_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE81861_ENCODE_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE81861_ENCODE_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE81861_ENCODE_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/GSE81861_ENCODE_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\_")[[1]][1])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat)
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
colnames(dat$ALRA) <- rownames(metadat)
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$celltype)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulkTPM(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"celltype",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_GSE81861.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$celltype)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulkTPM(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"celltype",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_GSE81861.rds")
```

## cellbench
### preprocess
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- readRDS("bulk/cellbench/GSE86337_processed_count.rds")
bulk_dat <- DGEList(bulk_dat)
bulk_dat <- calcNormFactors(bulk_dat)
bulk_meta <- c("HCC827","HCC827","H2228","H2228","H838","H838","A549","A549","H1975","H1975") 

##raw
raw_dat <- fread("rawcount_txt/cellbench_sc_10x_5cl_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/cellbench_sc_10x_5cl_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/cellbench_sc_10x_5cl_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/cellbench_sc_10x_5cl/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/cellbench_sc_10x_5cl_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/cellbench_sc_10x_5cl_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/cellbench_sc_10x_5cl_genebycell_cc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/cellbench_sc_10x_5cl_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/cellbench_sc_10x_5cl_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/cellbench_sc_10x_5cl_genebycell_scRMDlognorm.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/cellbench_sc_10x_5cl_genebycell_Bf_specc.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/cellbench_sc_10x_5cl_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\.")[[1]][2])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
colnames(dat$ALRA) <- rownames(metadat)
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$celltype)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"celltype",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_cellbench.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$celltype)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"celltype",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_cellbench.rds")
```

## summary and visualize
### P/FC sc-bulk correlations
#### sc level RST
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_RST",DE_res)]

datasets <- c("GSE75748","GSE81861","cellbench")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}

```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
p_all_res_melt$Type <- "Deep learning based"
p_all_res_melt[p_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
p_all_res_melt[p_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
p_all_res_melt$Type <- factor(p_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
head(p_all_res_melt)

P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
P_1k_res_melt$Type <- "Deep learning based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
P_1k_res_melt$Type <- factor(P_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_all_res_melt$Type <- "Deep learning based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_all_res_melt$Type <- factor(fc_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
fc_1k_res_melt$Type <- "Deep learning based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_1k_res_melt$Type <- factor(fc_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
```

Violin plot
p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(p_all[,-1],2,function(x) wilcox.test(p_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- p_all_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

mix_p_all_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Mixture)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.16,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_p_all_scc_bp_rst
```

heatmap
```{r fig.height=3}
tmp_hm <- p_all_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_p_all_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_p_all_scc_hm_rst
```

p_top1000_res
```{r}
#rank
mdv <- P_1k_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(P_1k[,-1],2,function(x) wilcox.test(P_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- P_1k_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1
mix_P_1k_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Mixture)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.13,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.01,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_P_1k_scc_bp_rst
```

heatmap
```{r fig.height=3}
tmp_hm <- P_1k_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_P_1k_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_P_1k_scc_hm_rst
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_all[,-1],2,function(x) wilcox.test(fc_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_all_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

mix_fc_all_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.2,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_fc_all_scc_bp_rst
```

heatmap
```{r fig.height=3}
tmp_hm <- fc_all_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_fc_all_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_fc_all_scc_hm_rst
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_1k[,-1],2,function(x) wilcox.test(fc_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_1k_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

mix_fc_1k_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Mixture)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.2,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_fc_1k_scc_bp_rst
```

heatmap
```{r fig.height=3}
tmp_hm <- fc_1k_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_fc_1k_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_fc_1k_scc_hm_rst
```

#### sc level MAST
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]
DE_res <- DE_res[!grepl("timecourse",DE_res)]

datasets <- c("GSE75748","GSE81861","cellbench")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}

```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
p_all_res_melt$Type <- "Deep learning based"
p_all_res_melt[p_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
p_all_res_melt[p_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
p_all_res_melt$Type <- factor(p_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
head(p_all_res_melt)

P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
P_1k_res_melt$Type <- "Deep learning based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
P_1k_res_melt$Type <- factor(P_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_all_res_melt$Type <- "Deep learning based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_all_res_melt$Type <- factor(fc_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
fc_1k_res_melt$Type <- "Deep learning based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_1k_res_melt$Type <- factor(fc_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
```

Violin plot
p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(p_all[,-1],2,function(x) wilcox.test(p_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- p_all_res_melt[,]
tmp_bp[tmp_bp$value<(-0.25),]$value <- -0.25
tmp_bp[tmp_bp$value>(0.25),]$value <- 0.25

mix_p_all_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Mixture)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.27,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_p_all_scc_bp_mast
```

heatmap
```{r fig.height=3}
tmp_hm <- p_all_res_melt[,]
tmp_hm[tmp_hm$value<(-0.25),]$value <- -0.25
tmp_hm[tmp_hm$value>(0.25),]$value <- 0.25
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_p_all_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_p_all_scc_hm_mast
```

p_top1000_res
```{r}
#rank
mdv <- P_1k_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(P_1k[,-1],2,function(x) wilcox.test(P_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- P_1k_res_melt[,]
tmp_bp[tmp_bp$value<(-0.3),]$value <- -0.3
tmp_bp[tmp_bp$value>(0.3),]$value <- 0.3
#mix_P_1k_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Method",palette=selected_palette)+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Mixture)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.35,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+NoLegend()+theme(axis.text.x=element_text(angle=90),axis.text=element_text(size=15),axis.title=element_text(size=18))

mix_P_1k_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Mixture)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.35,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_P_1k_scc_bp_mast
```

heatmap
```{r fig.height=3}
tmp_hm <- P_1k_res_melt[,]
tmp_hm[tmp_hm$value<(-0.3),]$value <- -0.3
tmp_hm[tmp_hm$value>(0.3),]$value <- 0.3
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_P_1k_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_P_1k_scc_hm_mast
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_all[,-1],2,function(x) wilcox.test(fc_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_all_res_melt[,]
tmp_bp[tmp_bp$value<(-0.25),]$value <- -0.25
tmp_bp[tmp_bp$value>(0.25),]$value <- 0.25

mix_fc_all_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.27,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_fc_all_scc_bp_mast
```

heatmap
```{r fig.height=3}
tmp_hm <- fc_all_res_melt[,]
tmp_hm[tmp_hm$value<(-0.25),]$value <- -0.25
tmp_hm[tmp_hm$value>(0.25),]$value <- 0.25
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_fc_all_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_fc_all_scc_hm_mast
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_1k[,-1],2,function(x) wilcox.test(fc_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_1k_res_melt[,]
tmp_bp[tmp_bp$value<(-0.2),]$value <- -0.2

mix_fc_1k_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Mixture)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.25,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_fc_1k_scc_bp_mast
```

heatmap
```{r fig.height=3}
tmp_hm <- fc_1k_res_melt[,]
tmp_hm[tmp_hm$value<(-0.2),]$value <- -0.2
colnames(tmp_hm)[3] <- "SCC_Difference"
mix_fc_1k_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_fc_1k_scc_hm_mast
```

### improve significance
#### sc level RST
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_RST",DE_res)]

datasets <- c("GSE75748","GSE81861","cellbench")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))
improve_sig_melt$Type <- "Deep learning based"
improve_sig_melt[improve_sig_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
improve_sig_melt[improve_sig_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
improve_sig_melt$Type <- factor(improve_sig_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(improve_sig_melt)
```

Violin plot
p_all_res
```{r}
#rank
mdv <- improve_sig_melt %>% group_by(variable) %>% summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

#performed tests
pv <- apply(p_all[,-c(1,ncol(p_all))],2,function(x) wilcox.test(p_all[,1],x,alternative="greater",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

mix_top_improve_bp_rst <- ggboxplot(improve_sig_melt,x="variable",y="value",fill="Type")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("Improved,%")+ggtitle("% of top500 DEGs with improved significance(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_top_improve_bp_rst
```

heatmap
```{r fig.height=3}
tmp_hm <- improve_sig_melt[,]
colnames(tmp_hm)[3] <- "improved_significance"
mix_top_improve_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_top_improve_hm_rst
```

#### sc level MAST
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]
DE_res <- DE_res[!grepl("timecourse",DE_res)]

datasets <- c("GSE75748","GSE81861","cellbench")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2,na.rm=TRUE)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))
improve_sig_melt$Type <- "Deep learning based"
improve_sig_melt[improve_sig_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
improve_sig_melt[improve_sig_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
improve_sig_melt$Type <- factor(improve_sig_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
head(improve_sig_melt)
```

Violin plot
```{r}
#rank
mdv <- improve_sig_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

#performed tests
pv <- apply(p_all[,-c(1,ncol(p_all))],2,function(x) wilcox.test(p_all[,1],x,alternative="greater",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

mix_top_improve_bp_mast <- ggboxplot(improve_sig_melt,x="variable",y="value",fill="Type")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("Improved,%")+ggtitle("% of top500 DEGs with improved significance(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_top_improve_bp_mast
```

heatmap
```{r fig.height=3}
tmp_hm <- improve_sig_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.2),-0.2,tmp_hm$value)
colnames(tmp_hm)[3] <- "improved_significance"
mix_top_improve_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_top_improve_hm_mast
```

### FP DEGs
read data
#### RST
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_RST",DE_res)]

datasets <- c("GSE75748","GSE81861","cellbench")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))

fp_rate_diff_melt$Type <- "Deep learning based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fp_rate_diff_melt$Type <- factor(fp_rate_diff_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(fp_rate_diff_melt)
```

Violin plot
fp_rate
```{r}
mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fp_rate[,-1],2,function(x) wilcox.test(fp_rate[,1],x,alternative="two.sided",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fp_rate_diff_melt[,]
tmp_bp[tmp_bp$value>0.2,]$value <- 0.2

mix_fp_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+xlab("Method")+ylab("FP rate Difference")+ggtitle("False Positive Rate Difference(Mixture)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.22,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_fp_bp_rst
```

heatmap
```{r fig.height=3}
tmp_hm <- fp_rate_diff_melt[,]
tmp_hm[tmp_hm$value>0.2,]$value <- 0.2
colnames(tmp_hm)[3] <- "FP_Difference"
mix_fp_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+xlab("Method")+ggtitle("False Positive Rate Difference(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_fp_hm_rst
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
head(fp_combined_diff_melt)
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
mix_fp_lp_rst <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Mixture)(Rank Sum)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
mix_fp_lp_rst
```

#### MAST
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]
DE_res <- DE_res[!grepl("timecourse",DE_res)]

datasets <- c("GSE75748","GSE81861","cellbench")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,500,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))

fp_rate_diff_melt$Type <- "Deep learning based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fp_rate_diff_melt$Type <- factor(fp_rate_diff_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(fp_rate_diff_melt)
```

Violin plot
fp_rate
```{r}
mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fp_rate[,-1],2,function(x) wilcox.test(fp_rate[,1],x,alternative="two.sided",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fp_rate_diff_melt[,]
tmp_bp[tmp_bp$value>0.2,]$value <- 0.2

mix_fp_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+xlab("Method")+ylab("FP rate Difference")+ggtitle("False Positive Rate Difference(Mixture)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.22,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
mix_fp_bp_mast
```

heatmap
```{r fig.height=3}
tmp_hm <- fp_rate_diff_melt[,]
tmp_hm[tmp_hm$value>0.2,]$value <- 0.2
colnames(tmp_hm)[3] <- "FP_Difference"
mix_fp_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+theme(axis.text.x=element_text(angle=90))+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("False Positive Rate Difference(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
mix_fp_hm_mast
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
head(fp_combined_diff_melt)
fp_combined_diff_melt <- fp_combined_diff_melt[fp_combined_diff_melt$variable!="New",]
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
mix_fp_lp_mast <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Mixture)(MAST)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
mix_fp_lp_mast
```


# purified cell type sample
## Angelidis2019_alvmac
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/Angelidis2019_alvmac_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)

##bulk
bulk_dat <- readRDS("bulk/confront18/Angelidis2019_alvmac_rawvoomnorm.rds")
bulk_meta <- bulk_dat$counts$samples$group
bulk_dat <- bulk_dat$counts

##raw
raw_dat <- fread("rawcount_txt/Angelidis2019_alvmac_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/Angelidis2019_alvmac_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/Angelidis2019_alvmac_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/Angelidis2019_alvmac/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/Angelidis2019_alvmac_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)

AutoClass_dat <- fread("AutoClass/Angelidis2019_alvmac_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/Angelidis2019_alvmac_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/Angelidis2019_alvmac_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/Angelidis2019_alvmac_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/Angelidis2019_alvmac_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/Angelidis2019_alvmac_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/Angelidis2019_alvmac_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_Angelidis2019_alvmac.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_Angelidis2019_alvmac.rds")
```


### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_Angelidis2019_alvmac.rds")
```

## Angelidis2019_pneumo
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/Angelidis2019_pneumo_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)

##bulk
bulk_dat <- readRDS("bulk/confront18/Angelidis2019_pneumo_rawvoomnorm.rds")
bulk_meta <- bulk_dat$counts$samples$group
bulk_dat <- bulk_dat$counts

##raw
raw_dat <- fread("rawcount_txt/Angelidis2019_pneumo_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/Angelidis2019_pneumo_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/Angelidis2019_pneumo_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/Angelidis2019_pneumo/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/Angelidis2019_pneumo_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)

AutoClass_dat <- fread("AutoClass/Angelidis2019_pneumo_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/Angelidis2019_pneumo_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/Angelidis2019_pneumo_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/Angelidis2019_pneumo_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/Angelidis2019_pneumo_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/Angelidis2019_pneumo_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/Angelidis2019_pneumo_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_Angelidis2019_pneumo.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_Angelidis2019_pneumo.rds")
```

### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_Angelidis2019_pneumo.rds")
```

## CanoGamez2020_memory_iTreg
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/CanoGamez2020_memory_iTreg_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)
metadat$replicate2 <- paste0(metadat$replicate,"_",metadat$label)

##bulk
bulk_dat <- readRDS("bulk/confront18/CanoGamez2020_memory-iTreg_rawvoomnorm.rds")
bulk_meta <- as.character(bulk_dat$counts$samples$group)
bulk_meta[bulk_meta=="Memory_iTreg"] <- "iTreg"
bulk_meta[bulk_meta=="Memory_Resting"] <- "UNS"
bulk_dat <- bulk_dat$counts

##raw
raw_dat <- fread("rawcount_txt/CanoGamez2020_memory_iTreg_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/CanoGamez2020_memory_iTreg_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/CanoGamez2020_memory_iTreg_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/CanoGamez2020_memory_iTreg/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/CanoGamez2020_memory_iTreg_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/CanoGamez2020_memory_iTreg_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/CanoGamez2020_memory_iTreg_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/CanoGamez2020_memory_iTreg_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/CanoGamez2020_memory_iTreg_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/CanoGamez2020_memory_iTreg_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/CanoGamez2020_memory_iTreg_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/CanoGamez2020_memory_iTreg_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_CanoGamez2020_memory_iTreg.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_CanoGamez2020_memory_iTreg.rds")
```

### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate2","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_CanoGamez2020_memory_iTreg.rds")
```

## CanoGamez2020_memory_Th0
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/CanoGamez2020_memory_Th0_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)
metadat$replicate2 <- paste0(metadat$replicate,"_",metadat$label)

##bulk
bulk_dat <- readRDS("bulk/confront18/CanoGamez2020_memory-Th0_rawvoomnorm.rds")
bulk_meta <- as.character(bulk_dat$counts$samples$group)
#bulk_meta[bulk_meta=="Th0"] <- "Th0"
bulk_meta[bulk_meta=="Resting"] <- "UNS"
bulk_dat <- bulk_dat$counts

#raw
raw_dat <- fread("rawcount_txt/CanoGamez2020_memory_Th0_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/CanoGamez2020_memory_Th0_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/CanoGamez2020_memory_Th0_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/CanoGamez2020_memory_Th0/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/CanoGamez2020_memory_Th0_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/CanoGamez2020_memory_Th0_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/CanoGamez2020_memory_Th0_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/CanoGamez2020_memory_Th0_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/CanoGamez2020_memory_Th0_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/CanoGamez2020_memory_Th0_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/CanoGamez2020_memory_Th0_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/CanoGamez2020_memory_Th0_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_CanoGamez2020_memory_Th0.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_CanoGamez2020_memory_Th0.rds")
```

### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate2","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_CanoGamez2020_memory_Th0.rds")
```

## CanoGamez2020_memory_Th2
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/CanoGamez2020_memory_Th2_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)
metadat$replicate2 <- paste0(metadat$replicate,"_",metadat$label)

##bulk
bulk_dat <- readRDS("bulk/confront18/CanoGamez2020_memory-Th2_rawvoomnorm.rds")
bulk_meta <- as.character(bulk_dat$counts$samples$group)
#bulk_meta[bulk_meta=="Th0"] <- "Th0"
bulk_meta[bulk_meta=="Resting"] <- "UNS"
bulk_dat <- bulk_dat$counts

#raw
raw_dat <- fread("rawcount_txt/CanoGamez2020_memory_Th2_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/CanoGamez2020_memory_Th2_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/CanoGamez2020_memory_Th2_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/CanoGamez2020_memory_Th2/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/CanoGamez2020_memory_Th2_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/CanoGamez2020_memory_Th2_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/CanoGamez2020_memory_Th2_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/CanoGamez2020_memory_Th2_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/CanoGamez2020_memory_Th2_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/CanoGamez2020_memory_Th2_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/CanoGamez2020_memory_Th2_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/CanoGamez2020_memory_Th2_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_CanoGamez2020_memory_Th2.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_CanoGamez2020_memory_Th2.rds")
```

### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate2","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_CanoGamez2020_memory_Th2.rds")
```

## CanoGamez2020_naive_iTreg
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/CanoGamez2020_naive_iTreg_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)
metadat$replicate2 <- paste0(metadat$replicate,"_",metadat$label)

##bulk
bulk_dat <- readRDS("bulk/confront18/CanoGamez2020_naive-iTreg_rawvoomnorm.rds")
bulk_meta <- as.character(bulk_dat$counts$samples$group)
#bulk_meta[bulk_meta=="Naive_iTreg"] <- "iTreg"
bulk_meta[bulk_meta=="Resting"] <- "UNS"
bulk_dat <- bulk_dat$counts

##raw
raw_dat <- fread("rawcount_txt/CanoGamez2020_naive_iTreg_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/CanoGamez2020_naive_iTreg_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/CanoGamez2020_naive_iTreg_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/CanoGamez2020_naive_iTreg/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/CanoGamez2020_naive_iTreg_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/CanoGamez2020_naive_iTreg_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/CanoGamez2020_naive_iTreg_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/CanoGamez2020_naive_iTreg_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/CanoGamez2020_naive_iTreg_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/CanoGamez2020_naive_iTreg_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/CanoGamez2020_naive_iTreg_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/CanoGamez2020_naive_iTreg_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_CanoGamez2020_naive_iTreg.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_CanoGamez2020_naive_iTreg.rds")
```

### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate2","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_CanoGamez2020_naive_iTreg.rds")
```

## CanoGamez2020_naive_Th0
### pre-processing
read data
```{r message=FALSE, warning=FALSE}
#metadata
metadat <- readRDS("rawcount_rds/CanoGamez2020_naive_Th0_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat$cell <- rownames(metadat)
metadat$replicate2 <- paste0(metadat$replicate,"_",metadat$label)

##bulk
bulk_dat <- readRDS("bulk/confront18/CanoGamez2020_naive-Th0_rawvoomnorm.rds")
bulk_meta <- as.character(bulk_dat$counts$samples$group)
#bulk_meta[bulk_meta=="Th0"] <- "Th0"
bulk_meta[bulk_meta=="Resting"] <- "UNS"
bulk_dat <- bulk_dat$counts

#raw
raw_dat <- fread("rawcount_txt/CanoGamez2020_naive_Th0_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/CanoGamez2020_naive_Th0_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/CanoGamez2020_naive_Th0_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
colnames(alra_dat) <- colnames(raw_dat)
dca_dat <- fread("dca/CanoGamez2020_naive_Th0/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/CanoGamez2020_naive_Th0_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/CanoGamez2020_naive_Th0_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/CanoGamez2020_naive_Th0_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/CanoGamez2020_naive_Th0_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/CanoGamez2020_naive_Th0_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/CanoGamez2020_naive_Th0_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/CanoGamez2020_naive_Th0_genebycell_Bf_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/CanoGamez2020_naive_Th0_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result rank sum
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_RST_CanoGamez2020_naive_Th0.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performDE_sc,metadat,"label",comb_status[1,i],comb_status[2,i],method="MAST"))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_CanoGamez2020_naive_Th0.rds")
```

### result PB limma
```{r message=FALSE, warning=FALSE}
status <- unique(metadat$label)
comb_status <- as.data.frame(combn(status,2))
res <- list()

#ncol(comb_status)
for(i in 1:ncol(comb_status)){
    bulk_res1 <- performDE_bulk(bulk_dat,bulk_meta,comb_status[1,i],comb_status[2,i])
    sc_res1 <- as.data.frame(lapply(dat,performPBDE_sc_limma,metadat,"label","replicate2","cell_type",comb_status[1,i],comb_status[2,i]))
    sc_res1 <- sc_res1[rownames(bulk_res1),]
    PairGroups <- paste0(comb_status[1,i],"_",comb_status[2,i])
    res[[paste0("bulk_",PairGroups)]] <- bulk_res1
    res[[paste0("sc_",PairGroups)]] <- sc_res1
}

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_PBlimma_CanoGamez2020_naive_Th0.rds")
```

## summary and visualize
### P/FC sc/PB-bulk correlations
#### sc level RST
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_RST",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}


```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
p_all_res_melt$Type <- "Deep learning based"
p_all_res_melt[p_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
p_all_res_melt[p_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
p_all_res_melt$Type <- factor(p_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
head(p_all_res_melt)

P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
P_1k_res_melt$Type <- "Deep learning based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
P_1k_res_melt$Type <- factor(P_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_all_res_melt$Type <- "Deep learning based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_all_res_melt$Type <- factor(fc_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
fc_1k_res_melt$Type <- "Deep learning based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_1k_res_melt$Type <- factor(fc_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
```

p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(p_all[,-1],2,function(x) wilcox.test(p_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- p_all_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_p_all_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Purified)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.06,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.01,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_p_all_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- p_all_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_p_all_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Purified)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_p_all_scc_hm_rst
```

p_top1000_res
```{r}
#rank
mdv <- P_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(P_1k[,-1],2,function(x) wilcox.test(P_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- P_1k_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_P_1k_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Purified)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.08,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.01,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_P_1k_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- P_1k_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_P_1k_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Purified)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_P_1k_scc_hm_rst
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_all[,-1],2,function(x) wilcox.test(fc_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_all_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_fc_all_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Purified)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.12,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.01,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fc_all_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- fc_all_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_fc_all_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fc_all_scc_hm_rst
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_1k[,-1],2,function(x) wilcox.test(fc_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_1k_res_melt[,]
tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_fc_1k_scc_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Purified)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.3,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fc_1k_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- fc_1k_res_melt[,]
tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_fc_1k_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Purified)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fc_1k_scc_hm_rst
```

#### sc level MAST
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}


```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
p_all_res_melt$Type <- "Deep learning based"
p_all_res_melt[p_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
p_all_res_melt[p_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
p_all_res_melt$Type <- factor(p_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
head(p_all_res_melt)

P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
P_1k_res_melt$Type <- "Deep learning based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
P_1k_res_melt$Type <- factor(P_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_all_res_melt$Type <- "Deep learning based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_all_res_melt$Type <- factor(fc_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
fc_1k_res_melt$Type <- "Deep learning based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_1k_res_melt$Type <- factor(fc_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
```

p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(p_all[,-1],2,function(x) wilcox.test(p_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- p_all_res_melt[,]

pur_p_all_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Purified)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.7,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.05,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_p_all_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- p_all_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_p_all_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Purified)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_p_all_scc_hm_mast
```

p_top1000_res
```{r}
#rank
mdv <- P_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(P_1k[,-1],2,function(x) wilcox.test(P_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- P_1k_res_melt[,]

pur_P_1k_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Purified)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.8,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.06,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_P_1k_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- P_1k_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_P_1k_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Purified)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_P_1k_scc_hm_mast
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_all[,-1],2,function(x) wilcox.test(fc_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_all_res_melt[,]

pur_fc_all_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Purified)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.5,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.05,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fc_all_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- fc_all_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_fc_all_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fc_all_scc_hm_mast
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_1k[,-1],2,function(x) wilcox.test(fc_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_1k_res_melt[,]

pur_fc_1k_scc_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Purified)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.5,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.04,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fc_1k_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- fc_1k_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_fc_1k_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Purified)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fc_1k_scc_hm_mast
```


#### PB level limma
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_PBlimma",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}


```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
p_all_res_melt$Type <- "Deep learning based"
p_all_res_melt[p_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
p_all_res_melt[p_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
p_all_res_melt$Type <- factor(p_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
head(p_all_res_melt)

P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
P_1k_res_melt$Type <- "Deep learning based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
P_1k_res_melt[P_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
P_1k_res_melt$Type <- factor(P_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_all_res_melt$Type <- "Deep learning based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_all_res_melt[fc_all_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_all_res_melt$Type <- factor(fc_all_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
fc_1k_res_melt$Type <- "Deep learning based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fc_1k_res_melt[fc_1k_res_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fc_1k_res_melt$Type <- factor(fc_1k_res_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))
```

p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(p_all[,-1],2,function(x) wilcox.test(p_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- p_all_res_melt[,]

pur_p_all_scc_bp_limma <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Purified)(PB-limma)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.05,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_p_all_scc_bp_limma
```

heatmap
```{r}
tmp_hm <- p_all_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_p_all_scc_hm_limma <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Purified)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_p_all_scc_hm_limma
```

p_top1000_res
```{r}
#rank
mdv <- P_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(P_1k[,-1],2,function(x) wilcox.test(P_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- P_1k_res_melt[,]
#tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_P_1k_scc_bp_limma <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Purified)(PB-limma)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.05,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_P_1k_scc_bp_limma
```

heatmap
```{r}
tmp_hm <- P_1k_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_P_1k_scc_hm_limma <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Purified)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_P_1k_scc_hm_limma
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_all[,-1],2,function(x) wilcox.test(fc_all[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_all_res_melt[,]
#tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_fc_all_scc_bp_limma <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Purified)(PB-limma)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.12,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fc_all_scc_bp_limma
```

heatmap
```{r}
tmp_hm <- fc_all_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_fc_all_scc_hm_limma <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Mixture)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fc_all_scc_hm_limma
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fc_1k[,-1],2,function(x) wilcox.test(fc_1k[,1],x,alternative="less",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fc_1k_res_melt[,]
#tmp_bp[tmp_bp$value<(-0.1),]$value <- -0.1

pur_fc_1k_scc_bp_limma <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("SCC Difference")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Purified)(PB-limma)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.3,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fc_1k_scc_bp_limma
```

heatmap
```{r}
tmp_hm <- fc_1k_res_melt[,]
#tmp_hm[tmp_hm$value<(-0.1),]$value <- -0.1
colnames(tmp_hm)[3] <- "SCC_Difference"
pur_fc_1k_scc_hm_limma <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Purified)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fc_1k_scc_hm_limma
```

### improve significance
#### sc level RST
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_RST",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))

improve_sig_melt$Type <- "Deep learning based"
improve_sig_melt[improve_sig_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
improve_sig_melt[improve_sig_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
improve_sig_melt$Type <- factor(improve_sig_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(improve_sig_melt)
```

Violin plot
p_all_res
```{r}
#rank
mdv <- improve_sig_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

#performed tests
pv <- apply(p_all[,-c(1,ncol(p_all))],2,function(x) wilcox.test(p_all[,1],x,alternative="greater",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

pur_top_improve_bp_rst <- ggboxplot(improve_sig_melt,x="variable",y="value",fill="Type")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("Improved,%")+ggtitle("% of top500 DEGs with improved significance(Purified)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_top_improve_bp_rst
```

heatmap
```{r}
tmp_hm <- improve_sig_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.2),-0.2,tmp_hm$value)
colnames(tmp_hm)[3] <- "improved_significance"
pur_top_improve_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Purified)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_top_improve_hm_rst
```

#### sc level MAST
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2,na.rm=TRUE)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))

improve_sig_melt$Type <- "Deep learning based"
improve_sig_melt[improve_sig_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
improve_sig_melt[improve_sig_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
improve_sig_melt$Type <- factor(improve_sig_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(improve_sig_melt)
```

Violin plot
p_all_res
```{r}
#rank
mdv <- improve_sig_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

#performed tests
pv <- apply(p_all[,-c(1,ncol(p_all))],2,function(x) wilcox.test(p_all[,1],x,alternative="greater",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

pur_top_improve_bp_mast <- ggboxplot(improve_sig_melt,x="variable",y="value",fill="Type")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("Improved,%")+ggtitle("% of top500 DEGs with improved significance(Purified)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_top_improve_bp_mast
```

heatmap
```{r}
tmp_hm <- improve_sig_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.2),-0.2,tmp_hm$value)
colnames(tmp_hm)[3] <- "improved_significance"
pur_top_improve_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Purified)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_top_improve_hm_mast
```

#### sc level PBlimma
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_PBlimma",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2,na.rm=TRUE)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))

improve_sig_melt$Type <- "Deep learning based"
improve_sig_melt[improve_sig_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
improve_sig_melt[improve_sig_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
improve_sig_melt$Type <- factor(improve_sig_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(improve_sig_melt)
```

Violin plot
p_all_res
```{r}
#rank
mdv <- improve_sig_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

#performed tests
pv <- apply(p_all[,-c(1,ncol(p_all))],2,function(x) wilcox.test(p_all[,1],x,alternative="greater",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

pur_top_improve_bp_limma <- ggboxplot(improve_sig_melt,x="variable",y="value",fill="Type")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ylab("Improved,%")+ggtitle("% of top500 DEGs with improved significance(Purified)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_top_improve_bp_limma
```

heatmap
```{r}
tmp_hm <- improve_sig_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.2),-0.2,tmp_hm$value)
colnames(tmp_hm)[3] <- "improved_significance"
pur_top_improve_hm_limma <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Purified)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_top_improve_hm_limma
```

### FP DEGs
read data
#### RST
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_RST",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))

fp_rate_diff_melt$Type <- "Deep learning based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fp_rate_diff_melt$Type <- factor(fp_rate_diff_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(fp_rate_diff_melt)
```

box plot
fp_rate
```{r}

mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fp_rate[,-1],2,function(x) wilcox.test(fp_rate[,1],x,alternative="two.sided",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fp_rate_diff_melt[,]
#tmp_bp[tmp_bp$value>0.2,]$value <- 0.2
pur_fp_bp_rst <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+xlab("Method")+ylab("FP rate Difference")+ggtitle("False Positive Rate Difference(Purified)(Rank Sum)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.05,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fp_bp_rst
```

heatmap
```{r}
tmp_hm <- fp_rate_diff_melt[,]
#tmp_hm[tmp_hm$value>0.2,]$value <- 0.2
colnames(tmp_hm)[3] <- "FP_Difference"
pur_fp_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+xlab("Method")+ggtitle("False Positive Rate Difference(Purified)(Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fp_hm_rst
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
head(fp_combined_diff_melt)
fp_combined_diff_melt <- fp_combined_diff_melt[fp_combined_diff_melt$variable!="New",]
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
pur_fp_lp_rst <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Purified)(Rank Sum)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
pur_fp_lp_rst
```


#### MAST
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))

fp_rate_diff_melt$Type <- "Deep learning based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fp_rate_diff_melt$Type <- factor(fp_rate_diff_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(fp_rate_diff_melt)
```

box plot
fp_rate
```{r}
mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fp_rate[,-1],2,function(x) wilcox.test(fp_rate[,1],x,alternative="two.sided",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fp_rate_diff_melt[,]
#tmp_bp[tmp_bp$value>0.2,]$value <- 0.2

pur_fp_bp_mast <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+xlab("Method")+ylab("FP rate Difference")+ggtitle("False Positive Rate Difference(Purified)(MAST)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.1,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.03,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fp_bp_mast
```

heatmap
```{r}
tmp_hm <- fp_rate_diff_melt[,]
#tmp_hm[tmp_hm$value>0.2,]$value <- 0.2
colnames(tmp_hm)[3] <- "FP_Difference"
pur_fp_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+theme(axis.text.x=element_text(angle=90))+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+xlab("Method")+ggtitle("False Positive Rate Difference(Purified)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fp_hm_mast
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
head(fp_combined_diff_melt)
fp_combined_diff_melt <- fp_combined_diff_melt[fp_combined_diff_melt$variable!="New",]
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
pur_fp_lp_mast <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Purified)(MAST)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
pur_fp_lp_mast
```


#### PBlimma
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_PBlimma",DE_res)]

datasets <- c("Angelidis2019_alvmac","Angelidis2019_pneumo","CanoGamez2020_memory_iTreg","CanoGamez2020_memory_Th0","CanoGamez2020_memory_Th2","CanoGamez2020_naive_iTreg","CanoGamez2020_naive_Th0")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))

fp_rate_diff_melt$Type <- "Deep learning based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
fp_rate_diff_melt[fp_rate_diff_melt$variable%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
fp_rate_diff_melt$Type <- factor(fp_rate_diff_melt$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

head(fp_rate_diff_melt)
```

box plot
fp_rate
```{r}
mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

#performed tests
pv <- apply(fp_rate[,-1],2,function(x) wilcox.test(fp_rate[,1],x,alternative="two.sided",paired=TRUE)$p.value )
pv_sig <- sapply(pv,getPsig)
pv_sig <- pv_sig[as.character(rank1)]

tmp_bp <- fp_rate_diff_melt[,]
#tmp_bp[tmp_bp$value>0.2,]$value <- 0.2

pur_fp_bp_limma <- ggboxplot(tmp_bp,x="variable",y="value",fill="Type")+geom_hline(yintercept=0,linetype="dashed")+xlab("Method")+ylab("FP rate Difference")+ggtitle("False Positive Rate Difference(Purified)(PB-limma)")+annotate(geom="text",x=c(1:length(pv_sig)),y=0.25,label=pv_sig,size=7)+annotate(geom="text",x=length(pv_sig)+2.3,y=0.02,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,length(pv_sig)+3.5))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
pur_fp_bp_limma
```

heatmap
```{r}
tmp_hm <- fp_rate_diff_melt[,]
#tmp_hm[tmp_hm$value>0.2,]$value <- 0.2
colnames(tmp_hm)[3] <- "FP_Difference"
pur_fp_hm_limma <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+xlab("Method")+ggtitle("False Positive Rate Difference(Purified)(PB-limma)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=8))
pur_fp_hm_limma
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
head(fp_combined_diff_melt)
fp_combined_diff_melt <- fp_combined_diff_melt[fp_combined_diff_melt$variable!="New",]
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
pur_fp_lp_limma <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Purified)(PB-limma)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
pur_fp_lp_limma
```

# time course sample
## GSE75748 time course
### preprocess
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- read.csv("bulk/GSE75748_bulk_time_course_ec.csv",header=TRUE,row.names=1)
bulk_dat <- DGEList(bulk_dat)
keep <- filterByExpr(bulk_dat)
bulk_dat <- bulk_dat[keep,,keep.lib.sizes=FALSE]
bulk_dat <- calcNormFactors(bulk_dat)
bulk_meta <- c(12,12,12,24,24,24,36,36,36,72,72,72,96,96,96) 

##raw
raw_dat <- fread("rawcount_txt/GSE75748_sc_timecourse_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE75748_sc_timecourse_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE75748_sc_timecourse_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE75748_sc_timecourse/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE75748_sc_timecourse_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE75748_sc_timecourse_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE75748_sc_timecourse_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE75748_sc_timecourse_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE75748_sc_timecourse_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE75748_sc_timecourse_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE75748_sc_timecourse_genebycell_Bfimpute_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/GSE75748_sc_timecourse_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)

metadat <- sapply(colnames(raw_dat),function(x) strsplit(x,"\\_")[[1]][1])
metadat <- sapply(metadat,function(x) strsplit(x,"\\.")[[1]][2])
metadat <- data.frame(cell=colnames(raw_dat),celltype=metadat)
metadat$time <- NA
metadat[metadat$celltype=="00hb4s",]$time <- 0
metadat[metadat$celltype=="12h",]$time <- 12
metadat[metadat$celltype=="24h",]$time <- 24
metadat[metadat$celltype=="36h",]$time <- 36
metadat[metadat$celltype=="72h",]$time <- 72
metadat[metadat$celltype=="96h",]$time <- 96

metadat$time_f <- factor(metadat$celltype,levels=c("00hb4s","12h","24h","36h","72h","96h")) 
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat)
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
colnames(dat$ALRA) <- rownames(metadat)
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result trend rank sum
run
```{r message=FALSE, warning=FALSE}
bulk_res1 <- performDE_bulk_timecourse(bulk_dat,bulk_meta)
sc_res1 <- as.data.frame(lapply(dat,getTrendRStest,metadat,"time_f"))
sc_res1 <- sc_res1[rownames(bulk_res1),]

res <- list(bulk_time=bulk_res1,sc_time=sc_res1)

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_TrendRST_GSE75748timecourse.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
bulk_res2 <- performDE_bulk_timecourse(bulk_dat,bulk_meta)
sc_res2 <- as.data.frame(lapply(dat,getMASTcont,metadat,"time"))
sc_res2 <- sc_res2[rownames(bulk_res2),]

res <- list(bulk_time=bulk_res2,sc_time=sc_res2)

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_GSE75748timecourse.rds")
```

## GSE79578
### preprocess
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- readRDS("bulk/GSE79578_bulkRNAseq_rawvoomnorm.rds")
bulk_dat <- bulk_dat$counts
keep <- filterByExpr(bulk_dat)
bulk_dat <- bulk_dat[keep,,keep.lib.sizes=FALSE]
bulk_dat <- calcNormFactors(bulk_dat)
bulk_meta <- c(0,0,6,12,24,36,48,60,72,84,96) 

##raw
raw_dat <- fread("rawcount_txt/GSE79578_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE79578_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE79578_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE79578/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE79578_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE79578_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE79578_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE79578_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE79578_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE79578_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE79578_genebycell_Bfimpute_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/GSE79578_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)

metadat <- readRDS("rawcount_rds/GSE79578_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat <- metadat[colnames(raw_dat),]

metadat$time <- NA
metadat[metadat$cell_type=="i2",]$time <- 0
metadat[metadat$cell_type=="h2",]$time <- 2
metadat[metadat$cell_type=="h12",]$time <- 12
metadat[metadat$cell_type=="h24",]$time <- 24
metadat[metadat$cell_type=="h36",]$time <- 36
metadat[metadat$cell_type=="h48",]$time <- 48
metadat[metadat$cell_type=="h60",]$time <- 60
metadat[metadat$cell_type=="h72",]$time <- 72
metadat[metadat$cell_type=="h96",]$time <- 96
metadat$cell <- rownames(metadat)
metadat$time_f <- factor(metadat$cell_type,levels=c("i2","h2","h12","h24","h36","h48","h60","h72","h96")) 
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat+min(Iimpute_dat[Iimpute_dat!=0]))
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
colnames(dat$ALRA) <- rownames(metadat)
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result trend rank sum
run
```{r message=FALSE, warning=FALSE}
bulk_res1 <- performDE_bulk_timecourse(bulk_dat,bulk_meta)
sc_res1 <- as.data.frame(lapply(dat,getTrendRStest,metadat,"time_f"))
sc_res1 <- sc_res1[rownames(bulk_res1),]

res <- list(bulk_time=bulk_res1,sc_time=sc_res1)

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_TrendRST_GSE79578.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
bulk_res2 <- performDE_bulk_timecourse(bulk_dat,bulk_meta)
sc_res2 <- as.data.frame(lapply(dat,getMASTcont,metadat,"time"))
sc_res2 <- sc_res2[rownames(bulk_res2),]

res <- list(bulk_time=bulk_res2,sc_time=sc_res2)

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_GSE79578timecourse.rds")
```

## GSE90047
### preprocess
read data
```{r message=FALSE, warning=FALSE}
##bulk
bulk_dat <- readRDS("bulk/GSE90047_Bulk-cell_RNA-seq_Read_Count_rawvoomnorm.rds")
bulk_dat <- bulk_dat$counts

bulk_meta <- as.numeric(as.character(bulk_dat$samples$group))

##raw
raw_dat <- fread("rawcount_txt/GSE90047_genebycell.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
raw_dat <- as.matrix(raw_dat,rownames=1)
##imputed
MAGIC_dat <- fread("MAGIC/GSE90047_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIC_dat <- as.matrix(MAGIC_dat,rownames=1)
alra_dat <- fread("alra/GSE90047_genebycell_alra.txt",sep="\t",stringsAsFactors=FALSE)
alra_dat <- as.matrix(alra_dat,rownames=1)
dca_dat <- fread("dca/GSE90047/mean.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
dca_dat <- as.matrix(dca_dat,rownames=1)
MAGIClog_dat <- fread("MAGIC_log/GSE90047_genebycell.tsv",sep="\t",header=TRUE,stringsAsFactors=FALSE)
MAGIClog_dat <- as.matrix(MAGIClog_dat,rownames=1)
AutoClass_dat <- fread("AutoClass/GSE90047_genebycell_AC.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
AutoClass_dat <- as.matrix(AutoClass_dat,rownames=1)
ccImpute_dat <- fread("ccImpute/GSE90047_genebycell_cc.txt",sep="\t",stringsAsFactors=FALSE)
ccImpute_dat <- as.matrix(ccImpute_dat,rownames=1)
ks_dat <- fread("knn_smoothing/GSE90047_genebycell_ks.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
ks_dat <- as.matrix(ks_dat,rownames=1)
Iimpute_dat <- fread("I_Impute/GSE90047_genebycell_CImp.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
Iimpute_dat <- as.matrix(Iimpute_dat,rownames=1)
scRMDnorm_dat <- fread("scRMD/GSE90047_genebycell_scRMDlognorm.txt",sep="\t",stringsAsFactors=FALSE)
scRMDnorm_dat <- as.matrix(scRMDnorm_dat,rownames=1)
Bf_dat <- fread("Bfimpute/GSE90047_genebycell_Bfimpute_specc.txt",sep="\t",stringsAsFactors=FALSE)
Bf_dat <- as.matrix(Bf_dat,rownames=1)

afMF_dat <- fread("afMF/imputed_data/GSE90047_sigma3_0_convergence_True.txt",sep="\t",header=TRUE,stringsAsFactors=FALSE)
afMF_dat <- as.matrix(afMF_dat,rownames=1)

metadat <- readRDS("rawcount_rds/GSE90047_rawnorm2.rds")
metadat <- as.data.frame(metadat@colData)
metadat <- metadat[colnames(raw_dat),]
metadat <- metadat[!metadat$cell_type%in%c("CD","CE","TD","TE","TUE","UE"),]
metadat$time <- NA
metadat[metadat$cell_type=="E10.5D",]$time <- 10.5
metadat[metadat$cell_type=="E11.5D",]$time <- 11.5
metadat[metadat$cell_type=="E11.5E",]$time <- 11.5
metadat[metadat$cell_type=="E12.5D",]$time <- 12.5
metadat[metadat$cell_type=="E12.5E",]$time <- 12.5
metadat[metadat$cell_type=="E13.5D",]$time <- 13.5
metadat[metadat$cell_type=="E13.5E",]$time <- 13.5
metadat[metadat$cell_type=="E14.5D",]$time <- 14.5
metadat[metadat$cell_type=="E14.5E",]$time <- 14.5
metadat[metadat$cell_type=="E15.5D",]$time <- 15.5
metadat[metadat$cell_type=="E15.5E",]$time <- 15.5
metadat[metadat$cell_type=="E17.5D",]$time <- 17.5
metadat[metadat$cell_type=="E17.5E",]$time <- 17.5

metadat$cell <- rownames(metadat)

raw_dat <- raw_dat[,metadat$cell]
alra_dat <- alra_dat[,metadat$cell]
AutoClass_dat <- AutoClass_dat[,metadat$cell]
Bf_dat <- Bf_dat[,metadat$cell]
ccImpute_dat <- ccImpute_dat[,metadat$cell]
dca_dat <- dca_dat[,metadat$cell]
Iimpute_dat <- Iimpute_dat[,metadat$cell]
ks_dat <- ks_dat[,metadat$cell]
MAGIC_dat <- MAGIC_dat[,metadat$cell]
MAGIClog_dat <- MAGIClog_dat[,metadat$cell]
New_dat <- New_dat[,metadat$cell]
scRMDnorm_dat <- scRMDnorm_dat[,metadat$cell]
afMF_dat <- afMF_dat[,metadat$cell]

metadat$time_f <- factor(metadat$time) 
```

normalized/log2 data
```{r}
raw_dat <- CreateSeuratObject(counts=raw_dat,meta.data=metadat,min.cells=0,min.features=0)
raw_dat <- NormalizeData(raw_dat)
raw_dat <- as.matrix(raw_dat@assays$RNA@data)

dca_dat <- log2(dca_dat)

ks_dat <- CreateSeuratObject(counts=ks_dat,meta.data=metadat,min.cells=0,min.features=0)
ks_dat <- NormalizeData(ks_dat)
ks_dat <- as.matrix(ks_dat@assays$RNA@data)

Iimpute_dat <- log2(Iimpute_dat)
```

combine normalized data
```{r}
dat <- list(raw=raw_dat,ALRA=alra_dat,AutoClass=AutoClass_dat,Bfimpute=Bf_dat,ccImpute=ccImpute_dat,DCA=dca_dat,I_Impute=Iimpute_dat,kNN_smoothing=ks_dat,MAGIC=MAGIC_dat,MAGIC_log=MAGIClog_dat,scRMD=scRMDnorm_dat,afMF=afMF_dat)
rm(raw_dat)
rm(alra_dat)
rm(AutoClass_dat)
rm(Bf_dat)
rm(ccImpute_dat)
rm(Iimpute_dat)
rm(ks_dat)
rm(dca_dat)
rm(MAGIC_dat)
rm(MAGIClog_dat)
rm(scRMDnorm_dat)
rm(afMF_dat)

#remove inconsistant genes
colnames(dat$ALRA) <- rownames(metadat)
bulk_dat <- bulk_dat[rownames(bulk_dat)%in%rownames(dat$DCA),]
dat <- lapply(dat,function(x) x[rownames(bulk_dat),] )
```

### result trend rank sum
run
```{r message=FALSE, warning=FALSE}
bulk_res1 <- performDE_bulk_timecourse(bulk_dat,bulk_meta)
sc_res1 <- as.data.frame(lapply(dat,getTrendRStest,metadat,"time_f"))
sc_res1 <- sc_res1[rownames(bulk_res1),]

res <- list(bulk_time=bulk_res1,sc_time=sc_res1)

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_TrendRST_GSE90047.rds")
```

### result MAST
```{r message=FALSE, warning=FALSE}
bulk_res2 <- performDE_bulk_timecourse(bulk_dat,bulk_meta)
sc_res2 <- as.data.frame(lapply(dat,getMASTcont,metadat,"time"))
sc_res2 <- sc_res2[rownames(bulk_res2),]

res <- list(bulk_time=bulk_res2,sc_time=sc_res2)

#writeout
saveRDS(res,"results/SC_Bulk_DEresults/Bulk_SC_SpearCor_DEresults_MAST_GSE90047timecourse.rds")
```

## summary and visualize
### P/FC sc/PB-bulk correlations
#### sc level Trend RST
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("_TrendRST_",DE_res)]

datasets <- c("GSE75748","GSE79578","GSE90047")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}


```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
head(p_all_res_melt)
P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
```

box plot
p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

p_all_res <- p_all_res[,colnames(p_all_res)!="New"]
tmp_bar <- p_all_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_p_all_scc_bp_rst <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Time-Course)(Trend Rank Sum)")+annotate(geom="text",x=ncol(p_all_res)+1.2,y=0.001,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(p_all_res)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_p_all_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- p_all_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_p_all_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_p_all_scc_hm_rst
```

P_1k_res
```{r}
#rank
mdv <- P_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

P_1k_res <- P_1k_res[,colnames(P_1k_res)!="New"]
tmp_bar <- P_1k_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_P_1k_scc_bp_rst <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Time-Course)(Trend Rank Sum)")+annotate(geom="text",x=ncol(P_1k_res)+1.2,y=0.002,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(P_1k_res)+2.2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_P_1k_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- P_1k_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_P_1k_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_P_1k_scc_hm_rst
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

fc_all_res <- fc_all_res[,colnames(fc_all_res)!="New"]
tmp_bar <- fc_all_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_fc_all_scc_bp_rst <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC Gene Z-value Rank SCC Difference(Time-Course)(Trend Rank Sum)")+annotate(geom="text",x=ncol(fc_all_res)+1.2,y=0.002,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(fc_all_res)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_fc_all_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- fc_all_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_fc_all_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Z-value Rank SCC Difference(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_fc_all_scc_hm_rst
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

fc_1k_res <- fc_1k_res[,colnames(fc_1k_res)!="New"]
tmp_bar <- fc_1k_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_fc_1k_scc_bp_rst <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC DEGs(Top1000) Z-value Rank SCC Difference(Time-Course)(Trend Rank Sum)")+annotate(geom="text",x=ncol(fc_1k_res)+1.2,y=0.002,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(fc_1k_res)+2.2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_fc_1k_scc_bp_rst
```

heatmap
```{r}
tmp_hm <- fc_1k_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_fc_1k_scc_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Z-value Rank SCC Difference(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_fc_1k_scc_hm_rst
```

#### sc level MAST
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]
DE_res <- DE_res[grep("timecourse",DE_res)]

datasets <- c("GSE75748","GSE79578","GSE90047")
p_all <- data.frame()
P_1k <- data.frame()
fc_all <- data.frame()
fc_1k <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    p1_005 <- data.frame()
    fc1_all <- data.frame()
    fc1_005 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        tmpres <- getAllEval(tmp[[bulkres]],tmp[[scres]])
        method_names <- rownames(tmpres$p)
        p1_all <- rbind(p1_all,tmpres$p$all)
        p1_005 <- rbind(p1_005,tmpres$p$`0.05`)
        fc1_all <- rbind(fc1_all,tmpres$fc$all)
        fc1_005 <- rbind(fc1_005,tmpres$fc$`0.05`)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- Compare_names
    colnames(p1_all) <- method_names
    rownames(p1_005) <- Compare_names
    colnames(p1_005) <- method_names
    rownames(fc1_all) <- Compare_names
    colnames(fc1_all) <- method_names
    rownames(fc1_005) <- Compare_names
    colnames(fc1_005) <- method_names
    
    p_all <- rbind(p_all,p1_all)
    P_1k <- rbind(P_1k,p1_005)
    fc_all <- rbind(fc_all,fc1_all)
    fc_1k <- rbind(fc_1k,fc1_005)
}
```

process data
```{r}
md_raw_p_all <- median(p_all$raw)
p_all_res <- as.data.frame(apply(p_all[,-1],2,function(x) x-p_all[,1] ))
p_all_res$group <- rownames(p_all_res)

md_raw_P_1k <- median(P_1k$raw)
P_1k_res <- as.data.frame(apply(P_1k[,-1],2,function(x) x-P_1k[,1] ))
P_1k_res$group <- rownames(P_1k_res)

md_raw_fc_all <- median(fc_all$raw)
fc_all_res <- as.data.frame(apply(fc_all[,-1],2,function(x) x-fc_all[,1] ))
fc_all_res$group <- rownames(fc_all_res)

md_raw_fc_1k <- median(fc_1k$raw)
fc_1k_res <- as.data.frame(apply(fc_1k[,-1],2,function(x) x-fc_1k[,1] ))
fc_1k_res$group <- rownames(fc_1k_res)

p_all_res_melt <- data.table::melt(p_all_res,id.vars=c("group"))
head(p_all_res_melt)
P_1k_res_melt <- data.table::melt(P_1k_res,id.vars=c("group"))
fc_all_res_melt <- data.table::melt(fc_all_res,id.vars=c("group"))
fc_1k_res_melt <- data.table::melt(fc_1k_res,id.vars=c("group"))
```

box plot
p_all_res
```{r}
#rank
mdv <- p_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
p_all_res_melt$Method <- as.character(p_all_res_melt$variable)
p_all_res_melt$variable <- factor(p_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

p_all_res <- p_all_res[,colnames(p_all_res)!="New"]
tmp_bar <- p_all_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_p_all_scc_bp_mast <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Time-Course)(MAST)")+annotate(geom="text",x=ncol(p_all_res)+1.2,y=0.006,label=paste0("Raw(Median=",round(md_raw_p_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(p_all_res)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_p_all_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- p_all_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_p_all_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene Sign(P) Rank SCC Difference(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_p_all_scc_hm_mast
```

P_1k_res
```{r}
#rank
mdv <- P_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
P_1k_res_melt$Method <- as.character(P_1k_res_melt$variable)
P_1k_res_melt$variable <- factor(P_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

P_1k_res <- P_1k_res[,colnames(P_1k_res)!="New"]
tmp_bar <- P_1k_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_P_1k_scc_bp_mast <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Time-Course)(MAST)")+annotate(geom="text",x=ncol(P_1k_res)+1.2,y=0.003,label=paste0("Raw(Median=",round(md_raw_P_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(P_1k_res)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_P_1k_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- P_1k_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_P_1k_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) Rank SCC Difference(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_P_1k_scc_hm_mast
```

fc_all_res
```{r}
#rank
mdv <- fc_all_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_all_res_melt$Method <- as.character(fc_all_res_melt$variable)
fc_all_res_melt$variable <- factor(fc_all_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

fc_all_res <- fc_all_res[,colnames(fc_all_res)!="New"]
tmp_bar <- fc_all_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_fc_all_scc_bp_mast <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Time-Course)(MAST)")+annotate(geom="text",x=ncol(fc_all_res)+1.2,y=0.01,label=paste0("Raw(Median=",round(md_raw_fc_all,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(fc_all_res)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_fc_all_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- fc_all_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_fc_all_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC Gene logFC Rank SCC Difference(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_fc_all_scc_hm_mast
```

fc_1k_res
```{r}
#rank
mdv <- fc_1k_res_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fc_1k_res_melt$Method <- as.character(fc_1k_res_melt$variable)
fc_1k_res_melt$variable <- factor(fc_1k_res_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

fc_1k_res <- fc_1k_res[,colnames(fc_1k_res)!="New"]
tmp_bar <- fc_1k_res[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "SCC_Difference"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_fc_1k_scc_bp_mast <- ggbarplot(tmp_bar,x="methods",y="SCC_Difference",fill="Type")+xlab("Method")+ylab("SCC Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Time-Course)(MAST)")+annotate(geom="text",x=ncol(fc_1k_res)+1.2,y=0.01,label=paste0("Raw(Median=",round(md_raw_fc_1k,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(fc_1k_res)+2.2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_fc_1k_scc_bp_mast
```

heatmap
```{r}
tmp_hm <- fc_1k_res_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "SCC_Difference"
tc_fc_1k_scc_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=SCC_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("Bulk-SC DEGs(Top1000) logFC Rank SCC Difference(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_fc_1k_scc_hm_mast
```

### improve significance
#### sc level RST
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("_TrendRST_",DE_res)]

datasets <- c("GSE75748","GSE79578","GSE90047")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))
head(improve_sig_melt)
```

bar plot
p_all_res
```{r}
#rank
mdv <- improve_sig_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

improve_sig <- improve_sig[,colnames(improve_sig)!="New"]
tmp_bar <- improve_sig[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "Improved"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_top_improve_bp_rst <- ggbarplot(tmp_bar,x="methods",y="Improved",fill="Type")+xlab("Method")+ylab("Improved,%")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("% of top500 DEGs with improved significance(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_top_improve_bp_rst
```

heatmap
```{r}
tmp_hm <- improve_sig_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.2),-0.2,tmp_hm$value)
colnames(tmp_hm)[3] <- "improved_significance"
tc_top_improve_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_top_improve_hm_rst
```

#### sc level MAST
read data
```{r message=FALSE, warning=FALSE}
#rank sum test
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]
DE_res <- DE_res[grep("timecourse",DE_res)]

datasets <- c("GSE75748","GSE79578","GSE90047")
p_all <- data.frame()
fc_all <- data.frame()
improve_sig <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    p1_all <- data.frame()
    fc1_all <- data.frame()
    improve_sig1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        selectedGenes <- rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),])[1:500]
        topgenesP_sc <- tmp[[scres]][selectedGenes,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(topgenesP_sc)
        topgenesFC_sc <- tmp[[scres]][selectedGenes,grep("logFC",colnames(tmp[[scres]]))]
        
        p1_all <- rbind(p1_all,topgenesP_sc)
        fc1_all <- rbind(fc1_all,topgenesFC_sc)
        
        improve_sig_tmp <- apply(topgenesP_sc[,-1],2,function(x) x<=topgenesP_sc[,1])
        same_dir_tmp <- apply(topgenesFC_sc[,-1],2,function(x) x*tmp[[bulkres]][selectedGenes,]$logFC>0)
        improve_sig_tmp <- improve_sig_tmp + same_dir_tmp
        improve_sig_tmp <- apply(improve_sig_tmp,2,function(x) sum(x==2,na.rm=TRUE)/length(x))
        
        improve_sig1 <- rbind(improve_sig1,improve_sig_tmp)
    }
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(p1_all) <- paste0(Compare_names,"_",rownames(p1_all))
    colnames(p1_all) <- method_names
    rownames(fc1_all) <- paste0(Compare_names,"_",rownames(fc1_all))
    colnames(fc1_all) <- method_names
    rownames(improve_sig1) <- Compare_names
    colnames(improve_sig1) <- method_names[-1]
    
    p_all <- rbind(p_all,p1_all)
    fc_all <- rbind(fc_all,fc1_all)
    improve_sig <- rbind(improve_sig,improve_sig1)
}
```

process data
```{r}
improve_sig$group <- rownames(improve_sig)
p_all$group <- rownames(p_all)
fc_all$group <- rownames(fc_all)
improve_sig_melt <- data.table::melt(improve_sig,id.vars=c("group"))
head(improve_sig_melt)
```

bar plot
p_all_res
```{r}
#rank
mdv <- improve_sig_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
improve_sig_melt$Method <- as.character(improve_sig_melt$variable)
improve_sig_melt$variable <- factor(improve_sig_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0.5)

improve_sig <- improve_sig[,colnames(improve_sig)!="New"]
tmp_bar <- improve_sig[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "Improved"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_top_improve_bp_mast <- ggbarplot(tmp_bar,x="methods",y="Improved",fill="Type")+xlab("Method")+ylab("Improved,%")+geom_hline(yintercept=0.5,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("% of top500 DEGs with improved significance(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_top_improve_bp_mast
```

heatmap
```{r}
tmp_hm <- improve_sig_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.2),-0.2,tmp_hm$value)
colnames(tmp_hm)[3] <- "improved_significance"
tc_top_improve_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=improved_significance))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0.5)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("% of top500 DEGs with improved significance(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_top_improve_hm_mast
```


### FP DEGs
read data
#### RST
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("_TrendRST_",DE_res)]

datasets <- c("GSE75748","GSE79578","GSE90047")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))
head(fp_rate_diff_melt)
```

Violin plot
fp_rate
```{r}
mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

fp_rate_diff <- fp_rate_diff[,colnames(fp_rate_diff)!="New"]
tmp_bar <- fp_rate_diff[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "FP_rate_diff"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_fp_bp_rst <- ggbarplot(tmp_bar,x="methods",y="FP_rate_diff",fill="Type")+xlab("Method")+ylab("FP rate Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("False Positive Rate Difference(Time-Course)(Trend Rank Sum)")+annotate(geom="text",x=ncol(fp_rate_diff)+1.2,y=0.005,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(fp_rate_diff)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_fp_bp_rst
```

heatmap
```{r}
tmp_hm <- fp_rate_diff_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "FP_Difference"
tc_fp_hm_rst <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("False Positive Rate Difference(Time-Course)(Trend Rank Sum)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_fp_hm_rst
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
fp_combined_diff_melt <- fp_combined_diff_melt[fp_combined_diff_melt$variable!="New",]
head(fp_combined_diff_melt)
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
tc_fp_lp_rst <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Time-Course)(Trend Rank Sum)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
tc_fp_lp_rst
```

#### MAST
```{r message=FALSE, warning=FALSE}
DE_res <- list.files("results/SC_Bulk_DEresults/")
DE_res <- DE_res[grep("Bulk_SC_SpearCor_DEresults_MAST",DE_res)]
DE_res <- DE_res[grep("timecourse",DE_res)]

datasets <- c("GSE75748","GSE79578","GSE90047")
fp_rate <- data.frame()
fp_rated2 <- data.frame()
fp_rated4 <- data.frame()
fp_rated5 <- data.frame()
fp_rated10 <- data.frame()

for(x in datasets){
    tmp <- DE_res[grep(x,DE_res)]
    tmppath <- paste0("results/SC_Bulk_DEresults/",tmp)
    tmp <- readRDS(tmppath)
    Compare_names <- unique(sapply(names(tmp),function(x) strsplit(x,"bulk|sc")[[1]][2] ))
    fp_rate1 <- data.frame()
    fp_rated2_1 <- data.frame()
    fp_rated4_1 <- data.frame()
    fp_rated5_1 <- data.frame()
    fp_rated10_1 <- data.frame()
    for(y in Compare_names){
        bulkres <- paste0("bulk",y)
        scres <- paste0("sc",y)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/3))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        #false_pos <- as.data.frame(false_pos)
        fp_rate1 <- rbind(fp_rate1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/2))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated2_1 <- rbind(fp_rated2_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/4))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated4_1 <- rbind(fp_rated4_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/5))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated5_1 <- rbind(fp_rated5_1,false_pos)
        
        selectedGenes <- tail(rownames(tmp[[bulkres]][order(tmp[[bulkres]]$P.Value),]),round(nrow(tmp[[bulkres]])/10))
        false_pos <- tmp[[scres]][,grep("P.Value",colnames(tmp[[scres]]))]
        method_names <- colnames(false_pos)
        false_pos <- apply(false_pos,2,getOverlappedDEGs,1000,rownames(tmp[[scres]]),selectedGenes)
        fp_rated10_1 <- rbind(fp_rated10_1,false_pos)
    }
    
    method_names <- sapply(method_names,function(x) strsplit(x,"\\.")[[1]][1] )
    Compare_names <- paste0(x,Compare_names)
    rownames(fp_rate1) <- Compare_names
    colnames(fp_rate1) <- method_names
    rownames(fp_rated2_1) <- Compare_names
    colnames(fp_rated2_1) <- method_names
    rownames(fp_rated4_1) <- Compare_names
    colnames(fp_rated4_1) <- method_names
    rownames(fp_rated5_1) <- Compare_names
    colnames(fp_rated5_1) <- method_names
    rownames(fp_rated10_1) <- Compare_names
    colnames(fp_rated10_1) <- method_names
    
    fp_rate <- rbind(fp_rate,fp_rate1)
    fp_rated2 <- rbind(fp_rated2,fp_rated2_1)
    fp_rated4 <- rbind(fp_rated4,fp_rated4_1)
    fp_rated5 <- rbind(fp_rated5,fp_rated5_1)
    fp_rated10 <- rbind(fp_rated10,fp_rated10_1)
}

fp_combined <- rbind(fp_rated10,fp_rated5,fp_rated4,fp_rate,fp_rated2)
```

process data
```{r}
md_raw <- median(fp_rate$raw)
fp_rate_diff <- as.data.frame(apply(fp_rate[,-1],2,function(x) x-fp_rate[,1] ))
fp_rate_diff$group <- rownames(fp_rate_diff)
fp_rate_diff_melt <- data.table::melt(fp_rate_diff,id.vars=c("group"))
head(fp_rate_diff_melt)
```

Violin plot
fp_rate
```{r}
mdv <- fp_rate_diff_melt %>% dplyr::group_by(variable) %>% dplyr::summarise(md=median(value,na.rm=TRUE))
rank1 <- mdv[order(mdv$md),]$variable
fp_rate_diff_melt$Method <- as.character(fp_rate_diff_melt$variable)
fp_rate_diff_melt$variable <- factor(fp_rate_diff_melt$variable,levels=rank1)
neg_md <- sum(mdv$md<=0)

fp_rate_diff <- fp_rate_diff[,colnames(fp_rate_diff)!="New"]
tmp_bar <- fp_rate_diff[,]
tmp_bar <- as.data.frame(apply(tmp_bar[,-ncol(tmp_bar)],2,median))
tmp_bar$methods <- rownames(tmp_bar)
tmp_bar$Method <- rownames(tmp_bar)
colnames(tmp_bar)[1] <- "FP_rate_diff"
tmp_bar$methods <- factor(tmp_bar$methods,levels=rank1)

tmp_bar$Type <- "Deep learning based"
tmp_bar[tmp_bar$Method%in%c("ccImpute","I_Impute","kNN_smoothing","MAGIC","MAGIC_log"),]$Type <- "Model or smoothing based"
tmp_bar[tmp_bar$Method%in%c("ALRA","Bfimpute","afMF","scRMD"),]$Type <- "Matrix based"
tmp_bar$Type <- factor(tmp_bar$Type,levels=c("Matrix based","Model or smoothing based","Deep learning based"))

tc_fp_bp_mast <- ggbarplot(tmp_bar,x="methods",y="FP_rate_diff",fill="Type")+xlab("Method")+ylab("FP rate Difference")+geom_hline(yintercept=0,linetype="dashed")+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+ggtitle("False Positive Rate Difference(Time-Course)(MAST)")+annotate(geom="text",x=ncol(fp_rate_diff)+1.2,y=0.005,label=paste0("Raw(Median=",round(md_raw,2),")"),size=4.5)+coord_cartesian(xlim=c(1,ncol(fp_rate_diff)+2))+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))+scale_fill_brewer(palette="Set2")
tc_fp_bp_mast
```

heatmap
```{r}
tmp_hm <- fp_rate_diff_melt[,]
#tmp_hm$value <- ifelse(tmp_hm$value<(-0.1),-0.1,tmp_hm$value)
colnames(tmp_hm)[3] <- "FP_Difference"
tc_fp_hm_mast <- ggplot(tmp_hm,aes(variable,group,fill=FP_Difference))+geom_tile()+scale_fill_gradient2(low="blue",mid="white",high="red",midpoint=0)+geom_vline(xintercept=neg_md+0.5,linetype="dashed")+xlab("Method")+ggtitle("False Positive Rate Difference(Time-Course)(MAST)")+theme(plot.title=element_text(size=16),legend.title=element_text(size=15),legend.text=element_text(size=14),axis.title=element_text(size=18),axis.text.x=element_text(angle=90,size=15),axis.text.y=element_text(size=15))
tc_fp_hm_mast
```

process data for line plot
```{r}
fp_combined_diff <- as.data.frame(apply(fp_combined[,-1],2,function(x) x-fp_combined[,1] ))
fp_combined_diff$group <- rownames(fp_combined_diff)
fp_combined_diff$Tail_PCT <- factor(rep(c("10%","20%","25%","33%","50%"),each=nrow(fp_rate)),levels=c("10%","20%","25%","33%","50%"))
fp_combined_diff_melt <- data.table::melt(fp_combined_diff,id.vars=c("group","Tail_PCT"))
fp_combined_diff_melt <- fp_combined_diff_melt[fp_combined_diff_melt$variable!="New",]
head(fp_combined_diff_melt)
```

line plot
```{r}
df <- data_summary(fp_combined_diff_melt,varname="value",groupnames=c("Tail_PCT","variable"))
head(df)
```

```{r}
colnames(df)[2] <- "Method"
df$Method <- as.character(df$Method)
tc_fp_lp_mast <- ggplot(df,aes(x=Tail_PCT,y=value,group=Method,color=Method))+geom_line()+geom_point()+theme_minimal()+xlab("Tail PCT Genes in Bulk")+ylab("False positive rate difference")+ggtitle("False Positive Rate Difference(Time-Course)(MAST)")+scale_color_manual(values=selected_palette)#+ylim(-0.15,0.15)+geom_errorbar(aes(ymin=value-sd,ymax=value+sd), width=.1,position=position_dodge(0.05))
tc_fp_lp_mast
```

# combine plots
## main:BP MAST all
```{r fig.height=8, fig.width=12.8}
ggarrange(mix_p_all_scc_bp_mast,pur_p_all_scc_bp_mast,tc_p_all_scc_bp_mast,mix_top_improve_bp_mast,pur_top_improve_bp_mast,tc_top_improve_bp_mast,mix_fp_bp_mast,pur_fp_bp_mast,tc_fp_bp_mast,ncol=3,nrow=3,labels="AUTO")
```

## supp:HM MAST all
```{r fig.height=5, fig.width=13.2}
ggarrange(mix_p_all_scc_hm_mast,pur_p_all_scc_hm_mast,tc_p_all_scc_hm_mast,mix_fp_hm_mast,pur_fp_hm_mast,tc_fp_hm_mast,ncol=3,nrow=2,labels="AUTO")
```

## supp:BP rank sum all
```{r fig.height=7.5, fig.width=12.8}
ggarrange(mix_p_all_scc_bp_rst,pur_p_all_scc_bp_rst,tc_p_all_scc_bp_rst,mix_top_improve_bp_rst,pur_top_improve_bp_rst,tc_top_improve_bp_rst,mix_fp_bp_rst,pur_fp_bp_rst,tc_fp_bp_rst,ncol=3,nrow=3,labels="AUTO")
```

## supp:HM rank sum all
```{r fig.height=5, fig.width=14.5}
ggarrange(mix_p_all_scc_hm_rst,pur_p_all_scc_hm_rst,tc_p_all_scc_hm_rst,mix_fp_hm_rst,pur_fp_hm_rst,tc_fp_hm_rst,ncol=3,nrow=2,labels="AUTO")
```

## supp:BP Top1000 sign(P) Mast and Rank Sum
```{r fig.height=5, fig.width=13.2}
tc_P_1k_scc_bp_rst <- tc_P_1k_scc_bp_rst+ggtitle("Bulk-SC DEGs(Top1000) Sign(P) SCC Difference(Time-Course)(Rank Sum)")
ggarrange(mix_P_1k_scc_bp_mast,pur_P_1k_scc_bp_mast,tc_P_1k_scc_bp_mast,mix_P_1k_scc_bp_rst,pur_P_1k_scc_bp_rst,tc_P_1k_scc_bp_rst,ncol=3,nrow=2,labels="AUTO")
```

## supp:BP tail improve MAST and Rank Sum(not shown)
```{r fig.height=5, fig.width=13}
ggarrange(mix_tail_improve_bp_mast,pur_tail_improve_bp_mast,tc_tail_improve_bp_mast,mix_tail_improve_bp_rst,pur_tail_improve_bp_rst,tc_tail_improve_bp_rst,ncol=3,nrow=2,labels="AUTO")
```

## supp:LP FP MAST and Rank Sum
```{r fig.height=4, fig.width=9}
ggarrange(mix_fp_lp_mast,pur_fp_lp_mast,tc_fp_lp_mast,mix_fp_lp_rst,pur_fp_lp_rst,tc_fp_lp_rst,ncol=3,nrow=2,labels="AUTO")
```

## supp:BP logFC Mast all and top1000
```{r fig.height=6, fig.width=13}
ggarrange(mix_fc_all_scc_bp_mast,pur_fc_all_scc_bp_mast,tc_fc_all_scc_bp_mast,mix_fc_1k_scc_bp_mast,pur_fc_1k_scc_bp_mast,tc_fc_1k_scc_bp_mast,ncol=3,nrow=2,labels="AUTO")
```


## supp:BP PBlimma all&Top1000 (p fc scc sig fp) 
```{r fig.height=7.6, fig.width=9}
ggarrange(pur_p_all_scc_bp_limma,pur_fc_all_scc_bp_limma,pur_P_1k_scc_bp_limma,pur_fc_1k_scc_bp_limma,pur_top_improve_bp_limma,pur_fp_bp_limma,ncol=2,nrow=3,labels="AUTO")
```



